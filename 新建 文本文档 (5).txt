ç°åœ¨æˆ‘ä»¬è¦å®Œæˆaiéƒ¨åˆ†çš„ä»£ç ï¼Œä¹‹å‰çš„æ˜¯ç”¨Pythonå†™çš„ï¼Œæœ€åæ˜¯å¼€ä¸€ä¸ªæ–°çš„æ¿å—æ¥å†™ï¼Œé¿å…å’Œå…¶ä»–ä»£ç å†²çªï¼Œ
æœ€åŸºæœ¬çš„èŠå¤©åŠŸèƒ½ï¼š
ç”¨æˆ·è¾“å…¥æ¡†ï¼š å…è®¸ç”¨æˆ·è¾“å…¥æ–‡æœ¬æ¶ˆæ¯ã€‚
AIå“åº”æ˜¾ç¤ºåŒºåŸŸï¼š æ˜¾ç¤ºAIç”Ÿæˆçš„æ¶ˆæ¯ã€‚
æµå¼å“åº”ï¼ˆStreamed Responseï¼‰ï¼š AIçš„æ¶ˆæ¯å†…å®¹ä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨æ˜¾ç¤ºï¼Œè€Œæ˜¯é€å­—æˆ–é€å¥åœ°é€æ­¥æ˜¾ç¤ºï¼Œæ¨¡æ‹Ÿâ€œæ‰“å­—æœºâ€æ•ˆæœã€‚
æ‰“å­—æœºæ•ˆæœï¼š è§†è§‰ä¸Šæ¨¡æ‹Ÿæ–‡å­—é€ä¸ªå­—ç¬¦å‡ºç°ï¼Œå¢åŠ äº¤äº’æ„Ÿã€‚
ä½¿ç”¨ Marked è§£æ Markdownï¼š AIçš„å“åº”å†…å®¹å¯ä»¥åŒ…å«Markdownæ ¼å¼ï¼ˆä¾‹å¦‚ï¼Œç²—ä½“ã€æ–œä½“ã€ä»£ç å—ã€åˆ—è¡¨ç­‰ï¼‰ï¼Œå¹¶ç”±Markedåº“è¿›è¡Œæ¸²æŸ“ï¼Œä½¿å…¶æ›´å…·å¯è¯»æ€§ã€‚
å¯å¤åˆ¶èŠå¤©å†…å®¹ï¼š å…è®¸ç”¨æˆ·é€‰æ‹©å¹¶å¤åˆ¶èŠå¤©è®°å½•ä¸­çš„æ–‡æœ¬å†…å®¹ã€‚
èŠå¤©å†å²è®°å½•ï¼š
æ˜¾ç¤ºèŠå¤©å†å²ï¼š ç”¨æˆ·å¯ä»¥çœ‹åˆ°å½“å‰å¯¹è¯çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨æˆ·å’ŒAIï¼‰ã€‚
èŠå¤©æºå¸¦èŠå¤©å†å²ï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼š åœ¨æ¯æ¬¡AIè¯·æ±‚æ—¶ï¼Œå°†ä¹‹å‰çš„éƒ¨åˆ†æˆ–å…¨éƒ¨å¯¹è¯å†å²ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ç»™AIæ¨¡å‹ï¼Œä»¥ä¾¿AIèƒ½ç†è§£å¹¶å“åº”ä¸ä¹‹å‰å¯¹è¯ç›¸å…³çš„é—®é¢˜ã€‚
æ–°å»ºèŠå¤©ï¼š æä¾›ä¸€ä¸ªæŒ‰é’®æˆ–é€‰é¡¹ï¼Œè®©ç”¨æˆ·å¯ä»¥å¼€å§‹ä¸€ä¸ªæ–°çš„ç©ºç™½å¯¹è¯ï¼Œæ¸…é™¤å½“å‰çš„èŠå¤©å†å²ã€‚
ç”¨æˆ·ä½“éªŒä¸ç•Œé¢ï¼š

åŠ è½½/æ€è€ƒçŠ¶æ€æŒ‡ç¤ºï¼š åœ¨AIç”Ÿæˆå“åº”æ—¶ï¼Œæ˜¾ç¤ºä¸€ä¸ªåŠ è½½åŠ¨ç”»æˆ–â€œAIæ­£åœ¨æ€è€ƒâ€çš„æç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·AIæ­£åœ¨å¤„ç†è¯·æ±‚ã€‚
æ»šåŠ¨åˆ°åº•éƒ¨ï¼š å½“æœ‰æ–°æ¶ˆæ¯ç”Ÿæˆæ—¶ï¼ŒèŠå¤©åŒºåŸŸè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯çš„åº•éƒ¨ã€‚
æ¶ˆæ¯æ—¶é—´æˆ³ï¼š æ¯æ¡æ¶ˆæ¯æ—è¾¹æ˜¾ç¤ºå‘é€/æ¥æ”¶çš„æ—¶é—´ï¼Œæ–¹ä¾¿è¿½è¸ªå¯¹è¯è¿›åº¦ã€‚
ç”¨æˆ·å¤´åƒå’ŒAIå¤´åƒï¼š ä¸ºç”¨æˆ·å’ŒAIçš„æ¶ˆæ¯åˆ†åˆ«æ˜¾ç¤ºä¸åŒçš„å¤´åƒï¼Œä½¿ç•Œé¢æ›´æ¸…æ™°ã€‚
å“åº”æ“ä½œæŒ‰é’®ï¼š
å¤åˆ¶æŒ‰é’®ï¼š åœ¨æ¯æ¡AIå“åº”æ—è¾¹æ·»åŠ ä¸€ä¸ªç‹¬ç«‹çš„å¤åˆ¶æŒ‰é’®ï¼Œæ–¹ä¾¿å¿«é€Ÿå¤åˆ¶å•æ¡æ¶ˆæ¯ã€‚
å¿«æ·é”®æ”¯æŒï¼š ä¾‹å¦‚ï¼ŒæŒ‰Enterå‘é€æ¶ˆæ¯ï¼ŒæŒ‰Shift+Enteræ¢è¡Œã€‚
å“åº”é€Ÿåº¦æ˜¾ç¤ºï¼š ï¼ˆå¯é€‰ï¼‰æ˜¾ç¤ºAIç”Ÿæˆæ­¤æ¡å“åº”æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚
åœæ­¢ç”ŸæˆæŒ‰é’®ï¼š åœ¨AIæ­£åœ¨ç”Ÿæˆå“åº”æ—¶ï¼Œæä¾›ä¸€ä¸ªæŒ‰é’®è®©ç”¨æˆ·å¯ä»¥æå‰åœæ­¢ç”Ÿæˆã€‚
ç°ä»£åŒ–çš„æ ·å¼



def deepseekR1(sid, messages):
    global current_ai_response
    # ç¡®ä¿å¼€å§‹æ–°çš„APIè°ƒç”¨æ—¶é‡ç½®AIå›å¤æ”¶é›†å˜é‡
    current_ai_response = ""

    # æ¸…é™¤åœæ­¢è¯·æ±‚æ ‡å¿—
    if sid in stop_requested:
        stop_requested[sid] = False

    # DeepSeek APIé…ç½®
    url = "https://alphachain.net.cn/openapi/v1/chat/completions"
    unique_id = str(uuid.uuid4().hex)
    payload = json.dumps({
        "userId": -1,
        "uniqueId": unique_id,
        # "model": "Pro/deepseek-ai/DeepSeek-R1",
        "model": "bot-20250218182311-kq7vj",
        "token": None,
        "temperature": 0.6,
        "top_p": 0.95,
        "presence_penalty": 0,
        "frequency_penalty": 0,
        "messages": messages,
        "stream": True,
        "max_tokens": 8192
    })

    try:
        session = requests.Session()
        session.trust_env = False
        response = session.post(url, headers=headers, data=payload, stream=True, timeout=8)

        for line in response.iter_lines():
            # æ£€æŸ¥æ˜¯å¦åº”è¯¥åœæ­¢æµ
            if sid in active_streams and active_streams[sid]['stop']:
                break
            if line:
                try:
                    decoded_line = line.decode('utf-8').strip()
                    if decoded_line.startswith('data:'):
                        json_str = decoded_line[5:].strip()
                        if json_str in ['', '[DONE]']:
                            if json_str == '[DONE]':
                                send_stream_message(is_done=True)
                            continue

                        data = json.loads(json_str)
                        if 'choices' in data and len(data['choices']) > 0:
                            delta = data['choices'][0].get('delta', {})

                            reasoning_chunk = delta.get('reasoning_content', '')
                            if reasoning_chunk:
                                send_stream_message("reasoning", reasoning_chunk)

                            content_chunk = delta.get('content', '')
                            if content_chunk:
                                send_stream_message("content", content_chunk)
                except Exception as e:
                    send_system_message(f"æœåŠ¡å™¨æš‚æ— å“åº”ï¼Œè¯·é‡æ–°å°è¯•ï¼{str(e)}")
                    break

    except requests.exceptions.RequestException as e:
        send_system_message(f"æœåŠ¡å™¨æš‚æ— å“åº”ï¼Œè¯·é‡æ–°å°è¯•ï¼{str(e)}")
    except Exception as e:
        send_system_message(f"æœåŠ¡å™¨æš‚æ— å“åº”ï¼Œè¯·é‡æ–°å°è¯•ï¼{str(e)}")
    finally:
        # æ¸…ç†æµæ§åˆ¶
        if sid in active_streams:
            del active_streams[sid]
        # æ¸…é™¤åœæ­¢è¯·æ±‚æ ‡å¿—
        if sid in stop_requested:
            stop_requested[sid] = False
        send_stream_message(is_done=True)
		
		
		
		
		
		
		
		
// å…¬å‘Šæ ç›¸å…³å‡½æ•°
function showbulletin(content) {
    const bulletinBar = document.getElementById('bulletinBar');
    const bulletinContent = document.getElementById('bulletinContent');
    
    if (bulletinBar && bulletinContent) {
        // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…URLæ¨¡å¼
        const urlPattern = /(https?:\/\/[^\s]+)/g;
        
        // å°†URLæ›¿æ¢ä¸ºHTMLé“¾æ¥
        const formattedContent = content.replace(urlPattern, url => {
            return `<a href="${url}" style="color: #0097ff";rel="noopener noreferrer">${url}</a>`;
        });
        
        // è®¾ç½®å†…å®¹ï¼ˆåŒ…å«HTMLæ ‡ç­¾ï¼‰
        bulletinContent.innerHTML = formattedContent;
        
        // ä¸ºæ‰€æœ‰é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
        bulletinContent.querySelectorAll('a').forEach(link => {
            const url = link.getAttribute('href');
            link.removeAttribute('target'); // ç§»é™¤targetå±æ€§
            link.onclick = function(e) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤æ‰“å¼€è¡Œä¸º
                openModPage(url); // ä½¿ç”¨å°çª—å£æ‰“å¼€
                return false;
            };
        });
        
        bulletinBar.style.display = 'flex';  // ç›´æ¥ä½¿ç”¨flexæ˜¾ç¤º
        bulletinBar.style.opacity = '1';
        bulletinBar.style.transform = 'none';
    }
}

function closebulletin() {
    const bulletinBar = document.getElementById('bulletinBar');
    if (bulletinBar) {
        bulletinBar.style.display = 'none';
    }
}

// è·å–å…¬å‘Šå†…å®¹
async function fetchbulletin() {
    try {
        const response = await fetch('/api/get-bulletin');
        const data = await response.json();
        
        if (data.success && data.bulletin) {
            showbulletin(data.bulletin);
        } else {
            // å¦‚æœæ²¡æœ‰å…¬å‘Šå†…å®¹ï¼Œä¹Ÿæ˜¾ç¤ºä¸€ä¸ªé»˜è®¤å…¬å‘Š
            showbulletin('æ¬¢è¿ä½¿ç”¨Nç½‘AIåŠ©æ‰‹ï¼Œæ”¯æŒä¸‰åƒå¤šæ¬¾æ¸¸æˆæ¨¡ç»„çš„ä¸‹è½½å’Œå®‰è£…æŒ‡å¯¼ï¼');
        }
    } catch (error) {
        console.error('è·å–å…¬å‘Šå¤±è´¥:', error);
        // å‘ç”Ÿé”™è¯¯æ—¶æ˜¾ç¤ºé»˜è®¤å…¬å‘Š
        showbulletin('æ¬¢è¿ä½¿ç”¨Nç½‘AIåŠ©æ‰‹ï¼Œæ”¯æŒä¸‰åƒå¤šæ¬¾æ¸¸æˆæ¨¡ç»„çš„ä¸‹è½½å’Œå®‰è£…æŒ‡å¯¼ï¼');
    }
}

// éšè—ç©ºçŠ¶æ€æ˜¾ç¤º
function hideEmptyState() {
    const messageArea = document.getElementById('messageArea');
    if (!messageArea) {
        console.warn('æ‰¾ä¸åˆ°æ¶ˆæ¯åŒºåŸŸ(#messageArea)');
        return;
    }
    
    const emptyState = messageArea.querySelector('.empty-message-state');
    if (emptyState) {
        emptyState.style.display = 'none';
    }
}

// å¤„ç†ç©ºçŠ¶æ€æ˜¾ç¤º
function handleEmptyState() {
    try {
        const messageArea = document.getElementById('messageArea');
        if (!messageArea) {
            console.warn('æ‰¾ä¸åˆ°æ¶ˆæ¯åŒºåŸŸ(#messageArea)');
            return;
        }
        
        // æ£€æŸ¥ç©ºçŠ¶æ€å…ƒç´ æ˜¯å¦å­˜åœ¨
        let emptyState = messageArea.querySelector('.empty-message-state');
        
        // å¦‚æœç©ºçŠ¶æ€å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!emptyState) {
            console.warn('æ‰¾ä¸åˆ°ç©ºçŠ¶æ€å…ƒç´ (.empty-message-state)ï¼Œæ­£åœ¨åˆ›å»º');
            emptyState = document.createElement('div');
            emptyState.className = 'empty-message-state';
            emptyState.style.display = 'none';
            messageArea.appendChild(emptyState);
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ¶ˆæ¯å†…å®¹ï¼ˆç”¨æˆ·æ¶ˆæ¯æˆ–AIæ¶ˆæ¯ï¼‰
        const hasMessages = messageArea.querySelector('.message:not(.empty-message-state)') !== null;
        
        if (hasMessages) {
            hideEmptyState();
        } else {
            emptyState.style.display = 'block';
            
            // å¦‚æœç©ºçŠ¶æ€å†…å®¹ä¸ºç©ºï¼Œå¡«å……é»˜è®¤å†…å®¹
            if (emptyState.innerHTML.trim() === '') {
                emptyState.innerHTML = generateEmptyStateHTML();
                
                // åˆå§‹åŒ–ç©ºçŠ¶æ€ä¸­çš„å¤´åƒ
                const avatar = emptyState.querySelector('.avatar.ai');
                if (avatar) {
                    initAvatarUpload(avatar);
                }
                
                // åŠ è½½å¤´åƒç¼“å­˜
                loadAvatarFromCache();
            }
        }
    } catch (error) {
        console.error('å¤„ç†ç©ºçŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯:', error);
    }
}

// åˆå§‹åŒ–Socket.IOè¿æ¥
const socket = io({
    reconnection: true,
    reconnectionAttempts: 5,
    reconnectionDelay: 1000
});

// æ¸¸æˆé€‰æ‹©ç›¸å…³å˜é‡
let currentPage = 1;
let isLoading = false;
let totalPages = 1;
let pageSize = 20;
let hasMoreGames = true;
let currentSearchQuery = '';
let selectedGame = null;

// å†å²æ¸¸æˆè®°å½•ç®¡ç†
const HISTORY_GAMES_KEY = 'historyGames';
const MAX_HISTORY_GAMES = 10;

// å…¨å±€å˜é‡ç”¨äºå­˜å‚¨å½“å‰æ¶ˆæ¯çš„çŠ¶æ€
let currentMessageDiv = null;
let currentThinkingDiv = null;
let currentAiContent = null;
let markdownBuffer = '';
let isProcessing = false;  // æ·»åŠ å¤„ç†çŠ¶æ€æ ‡å¿—
let thinkingStartTime = null; // æ·»åŠ æ€è€ƒå¼€å§‹æ—¶é—´
let userHasScrolled = false; // æ·»åŠ ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨æ ‡å¿—

// æ·»åŠ æ”¶è—ç›¸å…³çš„å¸¸é‡
const FAVORITE_GAMES_KEY = 'favoriteGames';

// å…¨å±€åŠ è½½æ•ˆæœæ§åˆ¶å™¨
const LoadingController = {
    loadingContainer: null,
    loadingText: null,

    // åˆå§‹åŒ–åŠ è½½æ•ˆæœ
    init() {
        // åˆ›å»ºåŠ è½½å®¹å™¨
        this.loadingContainer = document.createElement('div');
        this.loadingContainer.className = 'loading-container';
        
        // åˆ›å»ºåŠ è½½åŠ¨ç”»
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        
        // åˆ›å»ºåŠ è½½æ–‡æœ¬
        this.loadingText = document.createElement('div');
        this.loadingText.className = 'loading-text';
        
        // ç»„è£…åŠ è½½æ•ˆæœ
        this.loadingContainer.appendChild(spinner);
        this.loadingContainer.appendChild(this.loadingText);
        
        // æ·»åŠ åˆ°è¾“å…¥æ¡†å®¹å™¨
        const userInput = document.getElementById('userInput');
        if (userInput) {
            userInput.parentElement.appendChild(this.loadingContainer);
        }
    },

    // æ˜¾ç¤ºåŠ è½½æ•ˆæœ
    show(text = 'å¤„ç†ä¸­...') {
        if (!this.loadingContainer) {
            this.init();
        }
        this.loadingText.textContent = text;
        this.loadingContainer.classList.add('active');
        // ç¦ç”¨è¾“å…¥æ¡†
        const userInput = document.getElementById('userInput');
        if (userInput) {
            userInput.disabled = true;
        }
    },

    // éšè—åŠ è½½æ•ˆæœ
    hide() {
        if (this.loadingContainer) {
            this.loadingContainer.classList.remove('active');
            // å¯ç”¨è¾“å…¥æ¡†
            const userInput = document.getElementById('userInput');
            if (userInput) {
                userInput.disabled = false;
            }
        }
    },

    // æ›´æ–°åŠ è½½æ–‡æœ¬
    updateText(text) {
        if (this.loadingText) {
            this.loadingText.textContent = text;
        }
    }
};
// å…¨å±€é€šçŸ¥ç®¡ç†å™¨
const NotificationManager = {
    // é€šçŸ¥ç±»å‹
    types: {
        SUCCESS: 'success',
        ERROR: 'error',
        WARNING: 'warning',
        INFO: 'info'
    },

    // é€šçŸ¥é…ç½®
    config: {
        duration: 5000, // æ˜¾ç¤ºæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰å¢åŠ ä¸º5ç§’
        position: 'top-right', // ä½ç½®
        maxNotifications: 3, // æœ€å¤§åŒæ—¶æ˜¾ç¤ºæ•°é‡
        spacing: 15 // é€šçŸ¥ä¹‹é—´çš„é—´è·
    },

    // å½“å‰æ˜¾ç¤ºçš„é€šçŸ¥åˆ—è¡¨
    activeNotifications: [],

    // åˆå§‹åŒ–
    init() {
        // åˆ›å»ºé€šçŸ¥å®¹å™¨
        this.container = document.createElement('div');
        this.container.className = 'notification-container';
        document.body.appendChild(this.container);
    },

    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    createNotificationElement(message, type = this.types.INFO) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        
        // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
        let icon = '';
        switch (type) {
            case this.types.SUCCESS:
                icon = 'fa-check-circle';
                break;
            case this.types.ERROR:
                icon = 'fa-exclamation-circle';
                break;
            case this.types.WARNING:
                icon = 'fa-exclamation-triangle';
                break;
            case this.types.INFO:
                icon = 'fa-info-circle';
                break;
        }

        notification.innerHTML = `
            <i class="fas ${icon}"></i>
            <span class="notification-message">${message}</span>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;

        // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => this.removeNotification(notification));

        return notification;
    },

    // æ˜¾ç¤ºé€šçŸ¥
    show(message, type = this.types.INFO) {
        // ç¡®ä¿å®¹å™¨å­˜åœ¨
        if (!this.container) {
            this.init();
        }

        // åˆ›å»ºæ–°é€šçŸ¥
        const notification = this.createNotificationElement(message, type);
        
        // æ·»åŠ åˆ°å®¹å™¨
        this.container.appendChild(notification);
        
        // æ·»åŠ åˆ°æ´»åŠ¨é€šçŸ¥åˆ—è¡¨
        this.activeNotifications.push(notification);
        
        // æ›´æ–°é€šçŸ¥ä½ç½®
        this.updatePositions();
        
        // è®¾ç½®è‡ªåŠ¨å…³é—­
        setTimeout(() => {
            // å¦‚æœé€šçŸ¥ä»ç„¶å­˜åœ¨ï¼ˆå¯èƒ½å·²è¢«æ‰‹åŠ¨å…³é—­ï¼‰
            if (this.activeNotifications.includes(notification)) {
                notification.style.animation = 'notification-fade-out 0.3s forwards';
                setTimeout(() => this.removeNotification(notification), 300);
            }
        }, this.config.duration);
    },

    // ç§»é™¤é€šçŸ¥
    removeNotification(notification) {
        notification.classList.add('fade-out');
        notification.style.animation = 'notification-fade-out 0.3s forwards';
        
        setTimeout(() => {
            notification.remove();
            this.activeNotifications = this.activeNotifications.filter(n => n !== notification);
            this.updatePositions();
        }, 300);
    },

    // æ›´æ–°æ‰€æœ‰é€šçŸ¥çš„ä½ç½®
    updatePositions() {
        this.activeNotifications.forEach((notification, index) => {
            const top = index * (notification.offsetHeight + this.config.spacing);
            notification.style.top = `${top}px`;
        });
    },

    // å¿«æ·æ–¹æ³•
    success(message) {
        this.show(message, this.types.SUCCESS);
    },

    error(message) {
        this.show(message, this.types.ERROR);
    },

    warning(message) {
        this.show(message, this.types.WARNING);
    },

    info(message) {
        this.show(message, this.types.INFO);
    }
};
// è¿æ¥æˆåŠŸäº‹ä»¶
socket.on('connect', () => {
    console.log('Connected to server');
});

// æ¥æ”¶æ¶ˆæ¯äº‹ä»¶
socket.on('message', (data) => {
    disableChatHistorySwitch();
    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„æ¶ˆæ¯å®¹å™¨
    const isNewBubble = data.createNewBubble === true;
    const isDeepThinking = localStorage.getItem('isDeepThinking') === 'true';
    
    if (isNewBubble || !currentAiContent) {
        // å¦‚æœéœ€è¦åˆ›å»ºæ–°æ°”æ³¡æˆ–å½“å‰æ²¡æœ‰æ¶ˆæ¯å®¹å™¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
        // é‡ç½®å½“å‰æ¶ˆæ¯çŠ¶æ€
        markdownBuffer = '';
        currentThinkingDiv = null;
        currentAiContent = null;
        createNewMessageContainers();
    }

    try {
        if (data.error) {
            if (currentAiContent) {
                currentAiContent.textContent = 'é”™è¯¯: ' + data.error;
            }
            isProcessing = false;
            // æ›´æ–°æ€è€ƒåŒºåŸŸï¼Œä½†ä¸æŠ˜å 
            if (isDeepThinking && currentThinkingDiv) {
                updateThinkingHeader('æ€è€ƒå¤±è´¥');
            }
            LoadingController.hide();  // å‡ºé”™æ—¶éšè—åŠ è½½æ•ˆæœ
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯ç»“æŸæ ‡è®°
        if (data.data === '[DONE]') {
            console.log('æµç»“æŸ');
            document.querySelector('.stop-button').classList.add('hidden');
            document.querySelector('.stop-button').classList.remove('visible');

            // åœ¨æµç»“æŸæ—¶æ¸²æŸ“å®Œæ•´çš„æ¶ˆæ¯
            if (currentAiContent && markdownBuffer) {
                renderMessageContent(markdownBuffer, currentAiContent);
            }

            isProcessing = false;
            LoadingController.hide();  // å®Œæˆæ—¶éšè—åŠ è½½æ•ˆæœ
            // ç­‰å¾…ä¸¤ç§’åæ‰§è¡Œ
            setTimeout(() => {
                // æ¢å¤èŠå¤©å†å²åˆ‡æ¢åŠŸèƒ½
                enableChatHistorySwitch();
            }, 1000);
            return;
        }

        // è§£ææ¶ˆæ¯æ•°æ®
        const messageData = JSON.parse(data.data);

        if (messageData.type === 'reasoning' && isDeepThinking) {
            if (currentThinkingDiv) {
                // ç¡®ä¿æ€è€ƒåŒºåŸŸå¯è§
                currentThinkingDiv.style.display = 'block';

                // æ›´æ–°æ€è€ƒå†…å®¹
                const thinkingContent = currentThinkingDiv.querySelector('.thinking-content');
                if (thinkingContent) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ€è€ƒç»“æŸæ ‡è®°
                    if (messageData.content === 'ã€‚\n') {
                        // è®¡ç®—æ€è€ƒç”¨æ—¶
                        const thinkingEndTime = new Date();
                        const thinkingDuration = (thinkingEndTime - thinkingStartTime) / 1000; // è½¬æ¢ä¸ºç§’

                        // æ›´æ–°æ€è€ƒæ ‡é¢˜
                        updateThinkingHeader(`å·²æ€è€ƒ (ç”¨æ—¶ ${thinkingDuration.toFixed(1)} ç§’)`);

                        // ä¿æŒå±•å¼€çŠ¶æ€ï¼Œä¸è‡ªåŠ¨æŠ˜å 
                        currentThinkingDiv.classList.add('collapsed');
                        currentThinkingDiv.classList.remove('expanded');
                        const thinkingToggle = currentThinkingDiv.querySelector('.thinking-toggle');
                        if (thinkingToggle) {
                            thinkingToggle.classList.add('collapsed');
                        }
                    } else {
                        thinkingContent.textContent = (thinkingContent.textContent || '') + messageData.content;

                        // æ·»åŠ è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨çš„åŠŸèƒ½
                        if (currentThinkingDiv.classList.contains('expanded')) {
                            thinkingContent.scrollTop = thinkingContent.scrollHeight;
                        }
                    }
                }
            }
        } else if (messageData.type === 'content') {
            // ä½¿ç”¨markedè§£æMarkdown
            markdownBuffer = (markdownBuffer || '') + messageData.content;

            // ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½
            clearTimeout(window.renderTimeout);
            window.renderTimeout = setTimeout(() => {
                if (currentAiContent) {
                    renderMessageContent(markdownBuffer, currentAiContent);
                }
            }, 100);
        }

        const messageArea = document.getElementById('messageArea');
        // åªæœ‰å½“ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨æ»šåŠ¨æ—¶ï¼Œæ‰è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        if (!userHasScrolled) {
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    } catch (error) {
        console.error('å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:', error);
        if (currentAiContent) {
            currentAiContent.textContent = 'é”™è¯¯: ' + error.message;
        }
        // æŠ˜å æ€è€ƒåŒºåŸŸè€Œä¸æ˜¯éšè—
        if (isDeepThinking && currentThinkingDiv) {
            updateThinkingHeader('æ€è€ƒå‡ºé”™');
            currentThinkingDiv.classList.add('collapsed');
            currentThinkingDiv.classList.remove('expanded');
            const thinkingToggle = currentThinkingDiv.querySelector('.thinking-toggle');
            if (thinkingToggle) {
                thinkingToggle.classList.add('collapsed');
            }
        }
        isProcessing = false;
        LoadingController.hide();  // å‡ºé”™æ—¶éšè—åŠ è½½æ•ˆæœ
    }
});

// æ–­å¼€è¿æ¥äº‹ä»¶
socket.on('disconnect', () => {
    console.log('Disconnected from server');
    isProcessing = false;
});

// æ ¼å¼åŒ–æ—¶é—´æˆ³
function formatTimestamp(timestamp) {
    if (!timestamp) {
        return 'åˆšåˆš';
    }

    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;

    // å¦‚æœæ˜¯ä»Šå¤©çš„æ¶ˆæ¯
    if (date.toDateString() === now.toDateString()) {
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    // å¦‚æœæ˜¯æ˜¨å¤©çš„æ¶ˆæ¯
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === yesterday.toDateString()) {
        return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    // å…¶ä»–æ—¥æœŸæ˜¾ç¤ºå®Œæ•´æ—¥æœŸæ—¶é—´
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// åˆ›å»ºæ–°çš„æ¶ˆæ¯å®¹å™¨
function createNewMessageContainers() {
    const messageArea = document.getElementById('messageArea');
    const isDeepThinking = localStorage.getItem('isDeepThinking') === 'true';

    // åªåœ¨æ·±åº¦æ€è€ƒæ¨¡å¼å¼€å¯æ—¶åˆ›å»ºæ€è€ƒåŒºåŸŸ
    if (isDeepThinking) {
        // åˆ›å»ºAIæ€è€ƒåŒºåŸŸ
        currentThinkingDiv = document.createElement('div');
        currentThinkingDiv.className = 'thinking-area expanded';
        // ç”Ÿæˆå”¯ä¸€ID
        const thinkingId = 'thinking-' + Date.now();
        currentThinkingDiv.setAttribute('data-thinking-id', thinkingId);
        // é»˜è®¤æ˜¾ç¤ºæ€è€ƒåŒºåŸŸ
        currentThinkingDiv.style.display = 'block';

        // åˆ›å»ºæ€è€ƒåŒºåŸŸçš„å¤´éƒ¨
        const thinkingHeader = document.createElement('div');
        thinkingHeader.className = 'thinking-header';

        // åˆ›å»ºæ€è€ƒæ ‡é¢˜
        const thinkingTitle = document.createElement('div');
        thinkingTitle.className = 'thinking-title';

        // æ·»åŠ æ€è€ƒä¸­çš„æŒ‡ç¤ºå™¨
        const thinkingIndicator = document.createElement('div');
        thinkingIndicator.className = 'thinking-indicator';
        thinkingIndicator.innerHTML = 'æ€è€ƒä¸­ <div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div>';
        thinkingTitle.appendChild(thinkingIndicator);

        // æ·»åŠ æŠ˜å /å±•å¼€æŒ‰é’®
        const thinkingToggle = document.createElement('div');
        thinkingToggle.className = 'thinking-toggle';
        thinkingToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
        thinkingHeader.addEventListener('click', function () {
            const targetThinkingDiv = document.querySelector(`[data-thinking-id="${thinkingId}"]`);
            if (!targetThinkingDiv) return;

            if (targetThinkingDiv.classList.contains('collapsed')) {
                targetThinkingDiv.classList.remove('collapsed');
                targetThinkingDiv.classList.add('expanded');
                thinkingToggle.classList.remove('collapsed');

                // å±•å¼€åè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                const thinkingContent = targetThinkingDiv.querySelector('.thinking-content');
                if (thinkingContent) {
                    setTimeout(() => {
                        thinkingContent.scrollTop = thinkingContent.scrollHeight;
                    }, 100);
                }
            } else {
                targetThinkingDiv.classList.add('collapsed');
                targetThinkingDiv.classList.remove('expanded');
                thinkingToggle.classList.add('collapsed');
            }
        });

        // ç»„è£…å¤´éƒ¨
        thinkingHeader.appendChild(thinkingTitle);
        thinkingHeader.appendChild(thinkingToggle);
        currentThinkingDiv.appendChild(thinkingHeader);

        // åˆ›å»ºæ€è€ƒå†…å®¹åŒºåŸŸ
        const thinkingContent = document.createElement('div');
        thinkingContent.className = 'thinking-content';
        currentThinkingDiv.appendChild(thinkingContent);

        // ä½¿ç”¨MutationObserveræ›¿ä»£DOMNodeInserted
        const observer = new MutationObserver(function() {
            if (currentThinkingDiv.classList.contains('expanded')) {
                thinkingContent.scrollTop = thinkingContent.scrollHeight;
            }
        });
        
        observer.observe(thinkingContent, {
            childList: true,
            subtree: true,
            characterData: true
        });

        messageArea.appendChild(currentThinkingDiv);

        // è®°å½•æ€è€ƒå¼€å§‹æ—¶é—´
        thinkingStartTime = new Date();
    } else {
        // å¦‚æœä¸æ˜¯æ·±åº¦æ€è€ƒæ¨¡å¼ï¼Œé‡ç½®ç›¸å…³å˜é‡
        currentThinkingDiv = null;
        thinkingStartTime = null;
    }

    // åˆ›å»ºAIæ¶ˆæ¯åŒºåŸŸ
    const aiDiv = document.createElement('div');
    aiDiv.className = 'message';

    // æ·»åŠ æ—¶é—´æˆ³
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp(null);
    aiDiv.appendChild(timestamp);

    // æ·»åŠ AIå¤´åƒ
    const aiAvatar = document.createElement('div');
    aiAvatar.className = 'avatar ai';
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰å¤´åƒ
    const cachedAiAvatar = localStorage.getItem('aiAvatar');
    if (cachedAiAvatar) {
        aiAvatar.classList.add('custom-avatar');
        aiAvatar.classList.remove('default-avatar');
    } else {
        aiAvatar.classList.remove('custom-avatar');
        aiAvatar.classList.add('default-avatar');
    }
    
    // åˆå§‹åŒ–å¤´åƒç‚¹å‡»äº‹ä»¶
    initAvatarUpload(aiAvatar);
    
    aiDiv.appendChild(aiAvatar);

    // åˆ›å»ºAIå›å¤åŒºåŸŸ
    currentAiContent = document.createElement('div');
    currentAiContent.className = 'ai-message';
    aiDiv.appendChild(currentAiContent);
    messageArea.appendChild(aiDiv);
}

async function sendMessage() {
    
    const input = document.getElementById('userInput');
    const messageArea = document.getElementById('messageArea');
    const message = input.value.trim();

    if (!message || isProcessing) return;

    // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
    document.querySelector('.stop-button').classList.remove('hidden');
    document.querySelector('.stop-button').classList.add('visible');
    
    isProcessing = true;

    // è·å–æŒ‰é’®çŠ¶æ€
    const isDeepThinking = localStorage.getItem('isDeepThinking') === 'true';
    const isWebSearch = localStorage.getItem('isWebSearch') === 'true';

    // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯åŒºåŸŸ
    const userDiv = document.createElement('div');
    userDiv.className = 'message user-container';

    // æ·»åŠ æ—¶é—´æˆ³
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp(null);
    userDiv.appendChild(timestamp);

    // æ·»åŠ ç”¨æˆ·å¤´åƒ
    const userAvatar = document.createElement('div');
    userAvatar.className = 'avatar user';
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰ç”¨æˆ·å¤´åƒ
    const cachedUserAvatar = localStorage.getItem('userAvatar');
    if (cachedUserAvatar) {
        userAvatar.classList.add('custom-avatar');
        userAvatar.classList.remove('default-avatar');
    } else {
        userAvatar.classList.remove('custom-avatar');
        userAvatar.classList.add('default-avatar');
        userAvatar.textContent = 'U';
    }
    
    // åˆå§‹åŒ–å¤´åƒç‚¹å‡»äº‹ä»¶
    initAvatarUpload(userAvatar);
    
    userDiv.appendChild(userAvatar);

    // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯å†…å®¹
    const userContent = document.createElement('div');
    userContent.className = 'user-message';
    userContent.textContent = message;
    userDiv.appendChild(userContent);
    messageArea.appendChild(userDiv);

    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';

    // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
    input.style.height = 'auto';

    // å‘é€æ–°æ¶ˆæ¯æ—¶é‡ç½®æ»šåŠ¨æ ‡å¿—å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
    userHasScrolled = false;
    messageArea.scrollTop = messageArea.scrollHeight;

    // é‡ç½®markdownç¼“å†²åŒºå’Œæ¶ˆæ¯å®¹å™¨
    markdownBuffer = '';
    currentThinkingDiv = null;
    currentAiContent = null;

    // ç”Ÿæˆä¸€ä¸ªéšæœºidå€¼
    sid = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    // ç¼“å­˜åˆ°æœ¬åœ°
    localStorage.setItem('sid', sid);
    // éšè—ç©ºçŠ¶æ€æ˜¾ç¤º
    hideEmptyState()
    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ï¼ŒåŒ…å«æŒ‰é’®çŠ¶æ€
    socket.emit('send_message', { 
        message: message, 
        sid: sid,
        isDeepThinking: isDeepThinking,
        isWebSearch: isWebSearch
    });
    // åœ¨æ¶ˆæ¯å‘é€å®Œæˆåé‡æ–°åŠ è½½å†å²åˆ—è¡¨ï¼Œå¹¶ä¿æŒç¦ç”¨çŠ¶æ€
    await loadChatHistoryList();
}

function stopReceiving() {
    console.log('åœæ­¢æ¥æ”¶æ¶ˆæ¯');
    // ä»æœ¬åœ°ç¼“å­˜ä¸­è·å–sid
    const sid = localStorage.getItem('sid');
    if (!sid) {
        console.error('sidä¸å­˜åœ¨,æ— æ³•æš‚åœ');
        return;
    }
    socket.emit('stop_stream', { sid: sid });
    LoadingController.hide();  // åœæ­¢æ—¶éšè—åŠ è½½æ•ˆæœ

    // ç«‹å³æ›´æ–°UIçŠ¶æ€
    document.querySelector('.stop-button').classList.add('hidden');
    document.querySelector('.stop-button').classList.remove('visible');

    // ç¡®ä¿å®¢æˆ·ç«¯çŠ¶æ€ä¹Ÿè¢«é‡ç½®
    isProcessing = false;

    // æŠ˜å æ€è€ƒåŒºåŸŸè€Œä¸æ˜¯éšè—ï¼Œå¹¶æ˜¾ç¤ºæ€è€ƒç”¨æ—¶
    const isDeepThinking = localStorage.getItem('isDeepThinking') === 'true';
    if (isDeepThinking && currentThinkingDiv) {
        const thinkingContent = currentThinkingDiv.querySelector('.thinking-content');
        if (thinkingContent && thinkingContent.textContent.trim()) {
            // è®¡ç®—æ€è€ƒç”¨æ—¶
            const thinkingEndTime = new Date();
            const thinkingDuration = (thinkingEndTime - thinkingStartTime) / 1000; // è½¬æ¢ä¸ºç§’

            // æ›´æ–°æ€è€ƒæ ‡é¢˜
            updateThinkingHeader(`å·²åœæ­¢æ€è€ƒ (ç”¨æ—¶ ${thinkingDuration.toFixed(1)} ç§’)`);

            currentThinkingDiv.classList.add('collapsed');
            currentThinkingDiv.classList.remove('expanded');
            const thinkingToggle = currentThinkingDiv.querySelector('.thinking-toggle');
            if (thinkingToggle) {
                thinkingToggle.classList.add('collapsed');
            }
        }
    }

    // æ·»åŠ ä¸€ä¸ªæç¤ºï¼Œè¡¨æ˜æµå·²è¢«ç”¨æˆ·åœæ­¢
    if (currentAiContent) {
        // å…ˆæ¸²æŸ“å½“å‰çš„markdownå†…å®¹
        if (markdownBuffer && markdownBuffer.trim()) {
            renderMessageContent(markdownBuffer, currentAiContent);
        }
        
        // åˆ›å»ºåœæ­¢æ¶ˆæ¯å…ƒç´ 
        const stopMessage = document.createElement('div');
        stopMessage.className = 'stream-stopped-message';
        stopMessage.textContent = 'ï¼ˆæ¶ˆæ¯å·²è¢«ç”¨æˆ·åœæ­¢ï¼‰';
        
        // æ·»åŠ åˆ°AIæ¶ˆæ¯çš„æœ«å°¾
        currentAiContent.appendChild(stopMessage);
    }
    
    // æ¢å¤èŠå¤©å†å²åˆ‡æ¢åŠŸèƒ½
    enableChatHistorySwitch();
}

// æ·»åŠ å›è½¦å‘é€åŠŸèƒ½
document.getElementById('userInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// æ·»åŠ textareaè‡ªåŠ¨è°ƒæ•´é«˜åº¦åŠŸèƒ½
const textarea = document.getElementById('userInput');
textarea.addEventListener('input', function () {
    this.style.height = 'auto';
    const newHeight = Math.min(this.scrollHeight, 150);
    this.style.height = newHeight + 'px';
});

// ä¿®æ”¹å¤´åƒåŠ è½½å‡½æ•°
function loadAvatarFromCache() {
    // å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–AIå¤´åƒ
    const cachedAiAvatar = localStorage.getItem('aiAvatar');
    if (cachedAiAvatar) {
        // å¦‚æœæœ‰ç¼“å­˜ç›´æ¥ä½¿ç”¨
        updateAvatarDisplay('ai', cachedAiAvatar);
    } else {
        // æ²¡æœ‰ç¼“å­˜åˆ™ä»åç«¯è·å–
        fetch('/api/get-avatar/ai')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.avatar) {
                    // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                    localStorage.setItem('aiAvatar', data.avatar);
                    updateAvatarDisplay('ai', data.avatar);
                }
            })
            .catch(error => console.error('è·å–AIå¤´åƒå¤±è´¥:', error));
    }

    // å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–ç”¨æˆ·å¤´åƒ
    const cachedUserAvatar = localStorage.getItem('userAvatar');
    if (cachedUserAvatar) {
        // å¦‚æœæœ‰ç¼“å­˜ç›´æ¥ä½¿ç”¨
        updateAvatarDisplay('user', cachedUserAvatar);
    } else {
        // æ²¡æœ‰ç¼“å­˜åˆ™ä»åç«¯è·å–
        fetch('/api/get-avatar/user')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.avatar) {
                    // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                    localStorage.setItem('userAvatar', data.avatar);
                    updateAvatarDisplay('user', data.avatar);
                } else {
                    // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å¤´åƒ,æ˜¾ç¤ºé»˜è®¤çš„'U'
                    const userAvatars = document.querySelectorAll('.avatar.user');
                    userAvatars.forEach(avatar => {
                        avatar.classList.remove('custom-avatar');
                        avatar.classList.add('default-avatar');
                        avatar.textContent = 'U';
                    });
                }
            })
            .catch(error => console.error('è·å–ç”¨æˆ·å¤´åƒå¤±è´¥:', error));
    }
}

// æ·»åŠ å¤´åƒæ˜¾ç¤ºæ›´æ–°å‡½æ•°
function updateAvatarDisplay(type, avatarData) {
    const avatars = document.querySelectorAll(`.avatar.${type}`);
    const cssVar = type === 'ai' ? '--custom-avatar-url' : '--custom-user-avatar-url';
    
    document.documentElement.style.setProperty(cssVar, `url(${avatarData})`);
    avatars.forEach(avatar => {
        avatar.classList.add('custom-avatar');
        avatar.classList.remove('default-avatar');
        if (type === 'user') {
            avatar.textContent = '';
        }
    });
}

// ä¿®æ”¹å¤´åƒä¸Šä¼ å¤„ç†å‡½æ•°
function initAvatarUpload(avatar) {
    if (!avatar) return;
    
    avatar.style.cursor = 'pointer';
    avatar.title = 'ç‚¹å‡»æ›´æ¢å¤´åƒ';
    
    avatar.addEventListener('click', function() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    NotificationManager.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    const avatarType = avatar.classList.contains('ai') ? 'ai' : 'user';
                    
                    // è°ƒç”¨åç«¯APIä¿å­˜å¤´åƒ
                    fetch('/api/save-avatar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            avatar: base64Image,
                            type: avatarType
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                            localStorage.setItem(`${avatarType}Avatar`, base64Image);
                            // æ›´æ–°å¤´åƒæ˜¾ç¤º
                            updateAvatarDisplay(avatarType, base64Image);
                            NotificationManager.success('å¤´åƒæ›´æ–°æˆåŠŸ');
                        } else {
                            NotificationManager.error('å¤´åƒæ›´æ–°å¤±è´¥: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('ä¿å­˜å¤´åƒå¤±è´¥:', error);
                        NotificationManager.error('ä¿å­˜å¤´åƒå¤±è´¥');
                    });
                };
                reader.readAsDataURL(file);
            }
        });
        
        fileInput.click();
    });
}

// ä¿®æ”¹è·å–èŠå¤©å†å²è®°å½•çš„å‡½æ•°
async function fetchChatHistory() {
    try {
        const response = await fetch('/api/chat-history');
        const data = await response.json();
        
        if (data.success) {
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
            
            // å¦‚æœæœ‰æŒ‡å®šçš„ä¼šè¯æ–‡ä»¶ï¼ŒåŠ è½½è¯¥ä¼šè¯çš„å†…å®¹
            if (data.current_file) {
                const chatResponse = await fetch(`/api/load-chat?filename=${data.current_file}`);
                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    // æ¸²æŸ“å†å²æ¶ˆæ¯
                    chatData.messages.forEach(message => {
                        if (message.role === 'user') {
                            // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
                            const userDiv = document.createElement('div');
                            userDiv.className = 'message user-container';

                            // æ·»åŠ æ—¶é—´æˆ³
                            const timestamp = document.createElement('div');
                            timestamp.className = 'message-timestamp';
                            timestamp.textContent = formatTimestamp(message.timestamp);
                            userDiv.appendChild(timestamp);

                            const userAvatar = document.createElement('div');
                            userAvatar.className = 'avatar user';
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰ç”¨æˆ·å¤´åƒ
                            const cachedUserAvatar = localStorage.getItem('userAvatar');
                            if (cachedUserAvatar) {
                                userAvatar.classList.add('custom-avatar');
                                userAvatar.classList.remove('default-avatar');
                            } else {
                                userAvatar.classList.remove('custom-avatar');
                                userAvatar.classList.add('default-avatar');
                                userAvatar.textContent = 'U';
                            }
                            
                            // åˆå§‹åŒ–å¤´åƒç‚¹å‡»äº‹ä»¶
                            initAvatarUpload(userAvatar);
                            
                            userDiv.appendChild(userAvatar);

                            const userContent = document.createElement('div');
                            userContent.className = 'user-message';
                            userContent.textContent = message.content;
                            userDiv.appendChild(userContent);

                            messageArea.appendChild(userDiv);
                        } else if (message.role === 'assistant') {
                            // åˆ›å»ºAIæ¶ˆæ¯
                            const aiDiv = document.createElement('div');
                            aiDiv.className = 'message';

                            // æ·»åŠ æ—¶é—´æˆ³
                            const timestamp = document.createElement('div');
                            timestamp.className = 'message-timestamp';
                            timestamp.textContent = formatTimestamp(message.timestamp);
                            aiDiv.appendChild(timestamp);

                            const aiAvatar = document.createElement('div');
                            aiAvatar.className = 'avatar ai';
                            aiDiv.appendChild(aiAvatar);

                            const aiContent = document.createElement('div');
                            aiContent.className = 'ai-message';
                            renderMessageContent(message.content, aiContent);

                            aiDiv.appendChild(aiContent);
                            messageArea.appendChild(aiDiv);
                        }
                    });

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    messageArea.scrollTop = messageArea.scrollHeight;
                    
                    // åœ¨å†å²æ¶ˆæ¯åŠ è½½å®Œæˆåé‡æ–°åº”ç”¨å¤´åƒ
                    loadAvatarFromCache();
                    
                    // ä¸ºæ‰€æœ‰AIå¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
                    const aiAvatars = document.querySelectorAll('.avatar.ai');
                    aiAvatars.forEach(avatar => {
                        initAvatarUpload(avatar);
                    });
                }
            }
            
            // åŠ è½½èŠå¤©å†å²åˆ—è¡¨
            await loadChatHistoryList();
        } else {
            console.error('è·å–èŠå¤©å†å²å¤±è´¥:', data.error);
        }
    } catch (error) {
        console.error('è·å–èŠå¤©å†å²å‡ºé”™:', error);
    }
}

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–åŠ è½½æ•ˆæœ
    LoadingController.init();
    
    // åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨
    NotificationManager.init();
    
    // è·å–å…¬å‘Šå†…å®¹
    fetchbulletin();
    
    // åˆå§‹åŒ–ç©ºçŠ¶æ€
    handleEmptyState();
    
    // è·å–èŠå¤©å†å²è®°å½•
    fetchChatHistory();

    // åˆå§‹åŒ–textareaé«˜åº¦
    const textarea = document.getElementById('userInput');
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';

    // èšç„¦åˆ°è¾“å…¥æ¡†
    textarea.focus();

    // ä»æœ¬åœ°å­˜å‚¨è·å–æŒ‰é’®çŠ¶æ€
    const isDeepThinking = localStorage.getItem('isDeepThinking') !== 'false';  // ä¿®æ”¹é»˜è®¤å€¼é€»è¾‘
    const isWebSearch = localStorage.getItem('isWebSearch') === 'true';

    // æ·»åŠ æ·±åº¦æ€è€ƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const deepThinkingBtn = document.querySelector('.deep-thinking-text');
    if (deepThinkingBtn) {
        // è®¾ç½®åˆå§‹çŠ¶æ€ - é»˜è®¤å¼€å¯
        if (isDeepThinking) {
            deepThinkingBtn.classList.add('active');
            localStorage.setItem('isDeepThinking', 'true');  // ç¡®ä¿å­˜å‚¨çŠ¶æ€
        }
        
        deepThinkingBtn.addEventListener('click', function() {
            const currentState = this.classList.contains('active');
            if (currentState) {
                this.classList.remove('active');
                localStorage.setItem('isDeepThinking', 'false');
            } else {
                this.classList.add('active');
                localStorage.setItem('isDeepThinking', 'true');
            }
        });
    }

    // æ·»åŠ è”ç½‘æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const webSearchBtn = document.querySelector('.web-search-button');
    if (webSearchBtn) {
        // è®¾ç½®åˆå§‹çŠ¶æ€
        if (isWebSearch) {
            webSearchBtn.classList.add('active');
        }
        
        webSearchBtn.addEventListener('click', function() {
            // å¾…å¼€å‘
            NotificationManager.warning('è¿˜æ²¡åšå¥½è¿™ä¸ªåŠŸèƒ½ï¼Œå¯èµåŠ©ã€ğŸ‘+ğŸª™ğŸª™+è½¬å‘ä¸ºupæé€Ÿï¼ï¼ï¼');
            return
            const currentState = this.classList.contains('active');
            if (currentState) {
                this.classList.remove('active');
                localStorage.setItem('isWebSearch', 'false');
            } else {
                this.classList.add('active');
                localStorage.setItem('isWebSearch', 'true');
            }
        });
    }

    // æ·»åŠ é®ç½©å±‚åˆ°body
    if (!document.querySelector('.overlay')) {
        document.body.insertAdjacentHTML('beforeend', '<div class="overlay"></div>');
        const overlay = document.querySelector('.overlay');
        // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹å‡ºæ¡†
        overlay.addEventListener('click', closeHotModulesPopover);
    }

    // åˆå§‹åŒ–çƒ­é—¨æ¨¡ç»„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const hotModulesBtn = document.getElementById('hotModulesBtn');
    if (hotModulesBtn) {
        hotModulesBtn.addEventListener('click', getHotModules);
    }

    // ä¸ºæ‰€æœ‰å¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
    const aiAvatars = document.querySelectorAll('.avatar.ai');
    aiAvatars.forEach(avatar => {
        initAvatarUpload(avatar);
    });

    // åŠ è½½èŠå¤©å†å²åˆ—è¡¨
    loadChatHistoryList();

    // åˆå§‹è·å–åœ¨çº¿äººæ•°
    updateOnlineCount();
    
    // æ¯60ç§’æ›´æ–°ä¸€æ¬¡åœ¨çº¿äººæ•°
    setInterval(updateOnlineCount, 60000);
    
    // æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
    checkInitialization();
});

// ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åä¹Ÿå¤„ç†ä¸€æ¬¡å¤´åƒ
window.addEventListener('load', function() {
    // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´åå†æ¬¡å¤„ç†å¤´åƒï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²ç»å®Œå…¨æ¸²æŸ“
    setTimeout(loadAvatarFromCache, 100);
});

// è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°æ€è€ƒæ ‡é¢˜
function updateThinkingHeader(text) {
    if (currentThinkingDiv) {
        const thinkingIndicator = currentThinkingDiv.querySelector('.thinking-indicator');
        if (thinkingIndicator) {
            thinkingIndicator.innerHTML = text;
        }
    }
}

// æ·»åŠ é€šç”¨çš„æ¶ˆæ¯æ¸²æŸ“å‡½æ•°
function renderMessageContent(content, container) {
    try {
        // ä½¿ç”¨markedè§£æMarkdownå†…å®¹
        const parsed = marked.parse(content);
        container.innerHTML = parsed;
        
        // æ›´æ–°ç©ºçŠ¶æ€æ˜¾ç¤º
        handleEmptyState();
        
        // ä¸ºæ‰€æœ‰é“¾æ¥æ·»åŠ  onclick äº‹ä»¶ï¼Œä½¿ç”¨openModPageå‡½æ•°æ‰“å¼€
        container.querySelectorAll('a').forEach(link => {
            const url = link.getAttribute('href');
            link.setAttribute('rel', 'noopener noreferrer'); // ä¿ç•™å®‰å…¨å±æ€§
            link.removeAttribute('target'); // ç§»é™¤targetå±æ€§
            link.onclick = function(e) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤æ‰“å¼€è¡Œä¸º
                openModPage(url); // ä½¿ç”¨å°çª—å£æ‰“å¼€
                return false;
            };
        });

        // åº”ç”¨ä»£ç é«˜äº®
        container.querySelectorAll('pre code').forEach((block) => {
            try {
                if (hljs && typeof hljs.highlightElement === 'function') {
                    hljs.highlightElement(block);
                } else {
                    console.warn('highlight.js æœªæ­£ç¡®åŠ è½½æˆ–åˆå§‹åŒ–');
                }
            } catch (highlightError) {
                console.error('ä»£ç é«˜äº®é”™è¯¯:', highlightError);
            }
        });

        // ä¸ºæ‰€æœ‰ä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®
        container.querySelectorAll('pre').forEach(pre => {
            if (!pre.querySelector('.code-header')) {
                const codeHeader = document.createElement('div');
                codeHeader.className = 'code-header';

                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = '<i class="fas fa-copy"></i> å¤åˆ¶';
                copyButton.onclick = async () => {
                    try {
                        const code = pre.querySelector('code').textContent;
                        await navigator.clipboard.writeText(code);
                        copyButton.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                        copyButton.classList.add('copied');
                        setTimeout(() => {
                            copyButton.innerHTML = '<i class="fas fa-copy"></i> å¤åˆ¶';
                            copyButton.classList.remove('copied');
                        }, 2000);
                    } catch (err) {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        copyButton.innerHTML = '<i class="fas fa-times"></i> å¤åˆ¶å¤±è´¥';
                        setTimeout(() => {
                            copyButton.innerHTML = '<i class="fas fa-copy"></i> å¤åˆ¶';
                        }, 2000);
                    }
                };

                codeHeader.appendChild(copyButton);
                pre.parentNode.insertBefore(codeHeader, pre);
            }
        });
    } catch (e) {
        console.error('Markdownæ¸²æŸ“é”™è¯¯:', e);
        container.textContent = content;
    }
}


// æŠ½å±‰åˆ‡æ¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
    const chatToggle = document.getElementById('chatToggle');
    const chatDrawer = document.getElementById('chatDrawer');

    function toggleDrawer() {
        // å¦‚æœå¤„äºå…¨å±æ¨¡å¼ï¼Œå…ˆé€€å‡ºå…¨å±æ¨¡å¼
        if (chatDrawer.classList.contains('fullscreen-mode')) {
            chatDrawer.classList.remove('fullscreen-mode');
            const fullscreenToggle = document.getElementById('fullscreenToggle');
            if (fullscreenToggle) {
                fullscreenToggle.querySelector('i').classList.remove('fa-compress');
                fullscreenToggle.querySelector('i').classList.add('fa-expand');
            }
        }
        
        // ç„¶ååˆ‡æ¢æŠ½å±‰çŠ¶æ€
        chatDrawer.classList.toggle('active');
        
        // æ›´æ–°åˆ‡æ¢æŒ‰é’®å›¾æ ‡
        const icon = chatToggle.querySelector('i');
        if (chatDrawer.classList.contains('active')) {
            icon.classList.remove('fa-chevron-left');
            icon.classList.add('fa-chevron-right');
        } else {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-left');
        }
    }

    if (chatToggle) {
        chatToggle.addEventListener('click', toggleDrawer);
    }

    // ESC é”®å…³é—­æŠ½å±‰å’Œé€€å‡ºå…¨å±æ¨¡å¼
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            // å¦‚æœå¤„äºå…¨å±æ¨¡å¼ï¼Œå…ˆé€€å‡ºå…¨å±æ¨¡å¼
            if (chatDrawer.classList.contains('fullscreen-mode')) {
                chatDrawer.classList.remove('fullscreen-mode');
                const fullscreenToggle = document.getElementById('fullscreenToggle');
                if (fullscreenToggle) {
                    fullscreenToggle.querySelector('i').classList.remove('fa-compress');
                    fullscreenToggle.querySelector('i').classList.add('fa-expand');
                }
            } 
            // å¦‚æœæŠ½å±‰æ˜¯æ‰“å¼€çš„ï¼Œåˆ™å…³é—­æŠ½å±‰
            else if (chatDrawer.classList.contains('active')) {
                chatDrawer.classList.remove('active');
                const icon = chatToggle.querySelector('i');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        }
    });
});

// å…¨å±åˆ‡æ¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
    const fullscreenToggle = document.getElementById('fullscreenToggle');
    const chatDrawer = document.getElementById('chatDrawer');

    // é»˜è®¤è¿›å…¥å…¨å±æ¨¡å¼
    // chatDrawer.classList.add('fullscreen-mode');
    // fullscreenToggle.querySelector('i').classList.remove('fa-expand');
    // fullscreenToggle.querySelector('i').classList.add('fa-compress');

    fullscreenToggle.addEventListener('click', () => {
        // ä½¿ç”¨CSSç±»æ¥åˆ‡æ¢å…¨å±æ¨¡å¼ï¼Œè€Œä¸æ˜¯æµè§ˆå™¨API
        if (!chatDrawer.classList.contains('fullscreen-mode')) {
            // è¿›å…¥å…¨å±æ¨¡å¼
            chatDrawer.classList.add('fullscreen-mode');
            fullscreenToggle.querySelector('i').classList.remove('fa-expand');
            fullscreenToggle.querySelector('i').classList.add('fa-compress');
        } else {
            // é€€å‡ºå…¨å±æ¨¡å¼
            chatDrawer.classList.remove('fullscreen-mode');
            fullscreenToggle.querySelector('i').classList.remove('fa-compress');
            fullscreenToggle.querySelector('i').classList.add('fa-expand');
        }
    });

    // æ›´æ–°å…¨å±æŒ‰é’®å›¾æ ‡
    function updateFullscreenButtonIcon() {
        const icon = fullscreenToggle.querySelector('i');
        if (chatDrawer.classList.contains('fullscreen-mode')) {
            icon.classList.remove('fa-expand');
            icon.classList.add('fa-compress');
        } else {
            icon.classList.remove('fa-compress');
            icon.classList.add('fa-expand');
        }
    }
});

// è·å–çƒ­é—¨æ¨¡ç»„ç›¸å…³å‡½æ•°
function getHotModules() {
    const popover = document.getElementById('hotModulesPopover');
    const overlay = document.querySelector('.overlay');
    const button = document.getElementById('hotModulesBtn');

    if (popover && overlay && button) {
        // å®šä½å¼¹å‡ºæ¡†
        const buttonRect = button.getBoundingClientRect();

        // å°†å¼¹å‡ºæ¡†æ·»åŠ åˆ°bodyä»¥é¿å…è¢«çˆ¶å…ƒç´ çš„overflowå±æ€§å½±å“
        document.body.appendChild(popover);

        // è®¡ç®—å¼¹å‡ºæ¡†çš„ä½ç½®
        const left = buttonRect.left;
        const top = buttonRect.top - 10; // ç»™ä¸€ç‚¹é¢å¤–çš„ç©ºé—´

        popover.style.position = 'fixed';
        popover.style.left = left + 'px';
        popover.style.bottom = (window.innerHeight - top) + 'px';

        // ç¡®ä¿å¼¹å‡ºæ¡†ä¸ä¼šè¶…å‡ºè§†å£å·¦ä¾§
        if (left < 0) {
            popover.style.left = '10px';
        }

        // ç¡®ä¿å¼¹å‡ºæ¡†ä¸ä¼šè¶…å‡ºè§†å£å³ä¾§
        const popoverWidth = 350; // ä¸CSSä¸­å®šä¹‰çš„å®½åº¦ä¸€è‡´
        if (left + popoverWidth > window.innerWidth) {
            popover.style.left = (window.innerWidth - popoverWidth - 10) + 'px';
        }

        // æ¿€æ´»å¼¹å‡ºæ¡†å’Œé®ç½©
        popover.classList.add('active');
        overlay.classList.add('active');

        // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆä»Šå¤©åˆ°7å¤©åï¼‰
        const today = new Date();
        const nextWeek = new Date();
        nextWeek.setDate(today.getDate() + 7);

        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        initDateRangePicker(today, nextWeek);
    }
}

// åˆå§‹åŒ–æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
function initDateRangePicker(startDate, endDate) {
    // é”€æ¯ä¹‹å‰çš„å®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const dateRangePicker = $('#dateRangePicker').data('daterangepicker');
    if (dateRangePicker) {
        dateRangePicker.remove();
    }

    // åˆå§‹åŒ–æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
    $('#dateRangePicker').daterangepicker({
        startDate: startDate,
        endDate: endDate,
        opens: 'center',
        autoApply: true,
        locale: {
            format: 'YYYY-MM-DD',
            separator: ' è‡³ ',
            applyLabel: 'ç¡®å®š',
            cancelLabel: 'å–æ¶ˆ',
            fromLabel: 'ä»',
            toLabel: 'åˆ°',
            customRangeLabel: 'è‡ªå®šä¹‰',
            weekLabel: 'W',
            daysOfWeek: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'],
            monthNames: ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'],
            firstDay: 1
        },
        ranges: {
            'æ˜¨å¤©': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'æœ€è¿‘7å¤©': [moment().subtract(6, 'days'), moment()],
            'æœ€è¿‘30å¤©': [moment().subtract(29, 'days'), moment()],
            'æœ¬æœˆ': [moment().startOf('month'), moment().endOf('month')],
            'ä¸Šæœˆ': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        },
        // æ·»åŠ è‡ªå®šä¹‰èŒƒå›´çš„é»˜è®¤æ—¥æœŸ
        startDate: moment().subtract(2, 'days'),
        endDate: moment()
    }, function (start, end) {
        // æ›´æ–°éšè—çš„è¾“å…¥æ¡†å€¼
        document.getElementById('dateFrom').value = formatDate(start.toDate());
        document.getElementById('dateTo').value = formatDate(end.toDate());
    });

    // è®¾ç½®åˆå§‹å€¼
    document.getElementById('dateFrom').value = formatDate(startDate);
    document.getElementById('dateTo').value = formatDate(endDate);

    // è®¾ç½®æ˜¾ç¤ºæ–‡æœ¬
    $('#dateRangePicker').val(formatDate(startDate) + ' è‡³ ' + formatDate(endDate));
}

function closeHotModulesPopover() {
    const popover = document.getElementById('hotModulesPopover');
    const overlay = document.querySelector('.overlay');
    if (popover && overlay) {
        popover.classList.remove('active');
        overlay.classList.remove('active');
    }
}

// æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ä¸“é—¨æç¤ºç”¨æˆ·è¿™ä¸ªåŠŸèƒ½è¿˜æ²¡åšå¥½
function checkAutoDownload() {
    const isDownload = document.getElementById('isDownload').checked;
    if (isDownload) {
        NotificationManager.warning('è¿˜æ²¡åšå¥½ã€è‡ªåŠ¨ä¸‹è½½ã€‘è¿™ä¸ªåŠŸèƒ½ï¼Œè¯·å–æ¶ˆå‹¾é€‰ï¼Œå¯èµåŠ©ã€ğŸ‘+ğŸª™ğŸª™+è½¬å‘ä¸ºupæé€Ÿï¼ï¼ï¼');
        return false;
    }
    return true;
}

// æäº¤æŸ¥è¯¢
async function submitHotModules() {
    // æ£€æŸ¥è‡ªåŠ¨ä¸‹è½½åŠŸèƒ½
    if (!checkAutoDownload()) {
        return;
    }

    // ä»éšè—è¾“å…¥æ¡†è·å–æ—¥æœŸå€¼
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const sortBy = document.getElementById('sortBy').value;
    const isDownload = document.getElementById('isDownload').checked;

    // éªŒè¯æ—¥æœŸ
    if (!dateFrom || !dateTo) {
        NotificationManager.error('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        return;
    }

    // éªŒè¯æ—¥æœŸé¡ºåº
    if (new Date(dateFrom) > new Date(dateTo)) {
        NotificationManager.error('å¼€å§‹æ—¥æœŸä¸èƒ½å¤§äºç»“æŸæ—¥æœŸ');
        return;
    }
    // å…³é—­å¼¹å‡ºæ¡†
    closeHotModulesPopover();
    document.querySelector('.stop-button').classList.remove('hidden');
    document.querySelector('.stop-button').classList.add('visible');
    try {
        // è·å–sid
        const sid = localStorage.getItem('sid');
        const response = await fetch('/api/get-mods', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                date_from: dateFrom,
                date_to: dateTo,
                sort_by: sortBy,
                is_Download: isDownload,
                isDeepThinking: localStorage.getItem('isDeepThinking') === 'true',
                sid: sid
            })
        });

        const data = await response.json();

        if (data.success) {
            // æ›´æ–°æ€è€ƒæ ‡é¢˜
            // updateThinkingHeader(`å·²è·å–æ¨¡ç»„æ•°æ®`);
            //éšè—åœæ­¢æŒ‰é’®
            document.querySelector('.stop-button').classList.add('hidden');
            document.querySelector('.stop-button').classList.remove('visible');
        } else {
            console.error('è·å–æ¨¡ç»„æ•°æ®å¤±è´¥:', data.error);
            document.querySelector('.stop-button').classList.add('hidden');
            document.querySelector('.stop-button').classList.remove('visible');
        }
    } catch (error) {
        console.error('è¯·æ±‚å‡ºé”™:', error);
        document.querySelector('.stop-button').classList.add('hidden');
        document.querySelector('.stop-button').classList.remove('visible');
    }
}

// å·¥å…·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    const addToolsBtn = document.getElementById('addToolsBtn');
    const toolsPopover = document.getElementById('toolsPopover');
    const userInput = document.getElementById('userInput');

    // ç‚¹å‡»å·¥å…·æŒ‰é’®æ˜¾ç¤º/éšè—å¼¹å‡ºæ¡†
    addToolsBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toolsPopover.classList.toggle('active');
    });

    // ç‚¹å‡»å·¥å…·é¡¹æ’å…¥æ–‡æœ¬
    document.querySelectorAll('.tool-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.stopPropagation();
            const text = this.getAttribute('data-text');
            const cursorPos = userInput.selectionStart;
            const textBefore = userInput.value.substring(0, cursorPos);
            const textAfter = userInput.value.substring(cursorPos);
            
            userInput.value = textBefore + text + ' ' + textAfter;
            toolsPopover.classList.remove('active');
            
            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°æ’å…¥æ–‡æœ¬ä¹‹å
            const newPos = cursorPos + text.length + 1;
            userInput.setSelectionRange(newPos, newPos);
            userInput.focus();
        });
    });

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¼¹å‡ºæ¡†
    document.addEventListener('click', function(e) {
        if (!toolsPopover.contains(e.target) && e.target !== addToolsBtn) {
            toolsPopover.classList.remove('active');
        }
    });
});

// æ™ºèƒ½æ»šåŠ¨æŒ‰é’®åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const scrollButton = document.getElementById('scrollButton');
    const messageArea = document.getElementById('messageArea');
    let isAtBottom = true;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateScrollButtonState() {
        const scrollTop = messageArea.scrollTop;
        const scrollHeight = messageArea.scrollHeight;
        const clientHeight = messageArea.clientHeight;
        const scrollPercentage = (scrollTop + clientHeight) / scrollHeight;

        // æ ¹æ®æ»šåŠ¨ä½ç½®æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (scrollPercentage >= 0.95) {
            // åœ¨åº•éƒ¨æ—¶ï¼ŒæŒ‰é’®æ˜¾ç¤ºåœ¨åº•éƒ¨ï¼Œç®­å¤´å‘ä¸‹
            scrollButton.classList.remove('top');
            scrollButton.classList.add('bottom');
            scrollButton.title = 'æ»šåŠ¨åˆ°é¡¶éƒ¨';
            isAtBottom = true;
        } else if (scrollTop <= 100) {
            // åœ¨é¡¶éƒ¨æ—¶ï¼ŒæŒ‰é’®æ˜¾ç¤ºåœ¨é¡¶éƒ¨ï¼Œç®­å¤´å‘ä¸Š
            scrollButton.classList.add('top');
            scrollButton.classList.remove('bottom');
            scrollButton.title = 'æ»šåŠ¨åˆ°åº•éƒ¨';
            isAtBottom = false;
        } else if(scrollTop > 100 && scrollTop < 200) {
            // åœ¨ä¸­é—´ä½ç½®æ—¶ï¼ŒæŒ‰é’®æ˜¾ç¤ºåœ¨åº•éƒ¨ï¼Œç®­å¤´å‘ä¸‹
            scrollButton.classList.add('top');
            scrollButton.classList.remove('bottom');
            scrollButton.title = 'æ»šåŠ¨åˆ°åº•éƒ¨';
            isAtBottom = false;
        }
        else {

        }
    }

    // ç‚¹å‡»æŒ‰é’®å¤„ç†
    scrollButton.addEventListener('click', function() {
        if (isAtBottom) {
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            messageArea.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        } else {
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageArea.scrollTo({
                top: messageArea.scrollHeight,
                behavior: 'smooth'
            });
        }
    });

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    messageArea.addEventListener('scroll', updateScrollButtonState);
    
    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    updateScrollButtonState();
});
async function updateAllMods() {
    NotificationManager.warning('è¿˜æ²¡åšå¥½è¿™ä¸ªåŠŸèƒ½ï¼Œå¯èµåŠ©ã€ğŸ‘+ğŸª™ğŸª™+è½¬å‘ä¸ºupæé€Ÿï¼ï¼ï¼');
}

async function fnex() {
    NotificationManager.warning('è¿˜æ²¡åšå¥½è¿™ä¸ªåŠŸèƒ½ï¼Œå¯èµåŠ©ã€ğŸ‘+ğŸª™ğŸª™+è½¬å‘ä¸ºupæé€Ÿï¼ï¼ï¼');
}

// å­˜å‚¨MODåˆ—è¡¨æ•°æ®
let modsList = [];

// æ‰“å¼€æ‰¹é‡ä¸‹è½½æ¨¡æ€çª—å£
async function batchDownload() {
    try {
        // æ˜¾ç¤ºåŠ è½½æ•ˆæœ
        LoadingController.show('æ­£åœ¨è·å–å¯ä¸‹è½½çš„MODåˆ—è¡¨...');
        
        // è·å–ä¸‹è½½é“¾æ¥
        const response = await fetch('/api/get-download-links', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                isDeepThinking: localStorage.getItem('isDeepThinking') === 'true'
            })
        });
        
        if (!response.ok) {
            throw new Error('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥');
        }
        
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'è·å–ä¸‹è½½é“¾æ¥å¤±è´¥');
        }
        
        // æ›´æ–°MODåˆ—è¡¨
        modsList = data.links.map((link, index) => ({
            id: index,
            name: link.name || 'æœªçŸ¥MOD',
            nameCn: link.nameCn || 'æœªçŸ¥MOD',
            url: link.url,
            mod_id: link.mod_id || '',
            mod_url: link.mod_url || '',
            mod_size: link.mod_size || 'æœªçŸ¥å¤§å°',
            selected: false,
            status: link.is_downloaded ? 'completed' : 'pending', // æ ¹æ®æ˜¯å¦å·²ä¸‹è½½è®¾ç½®çŠ¶æ€
            progress: link.is_downloaded ? 100 : 0
        }));
        
        // æ¸²æŸ“MODåˆ—è¡¨
        renderModsList();
        
        // æ˜¾ç¤ºæ¨¡æ€çª—å£
        const modal = document.getElementById('batchDownloadModal');
        modal.classList.add('active');
        
        // éšè—åŠ è½½æ•ˆæœ
        LoadingController.hide();
        
    } catch (error) {
        console.error('æ‰¹é‡ä¸‹è½½åˆå§‹åŒ–å¤±è´¥:', error);
        LoadingController.hide();
        NotificationManager.error('è·å–MODåˆ—è¡¨å¤±è´¥: ' + error.message);
    }
}

// å…³é—­æ¨¡æ€çª—å£
function closeBatchDownloadModal() {
    const modal = document.getElementById('batchDownloadModal');
    modal.classList.remove('active');
}

// æ¸²æŸ“MODåˆ—è¡¨
function renderModsList() {
    const container = document.getElementById('modsList');
    container.innerHTML = '';
    modsList.forEach(mod => {
        const modElement = document.createElement('div');
        modElement.className = 'mod-item';
        modElement.dataset.modId = mod.id;  // æ·»åŠ dataå±æ€§ç”¨äºæœç´¢
        modElement.innerHTML = `
            <label class="checkbox-label">
                <span class="custom-checkbox">
                    <input type="checkbox" ${mod.selected ? 'checked' : ''} onchange="toggleMod(${mod.id})">
                    <span class="checkmark"></span>
                </span>
            </label>
            <div class="mod-info">
                ${mod.mod_id ? `
                    <div class="mod-id-container">
                        <span class="mod-id" title="ç‚¹å‡»è®¿é—®MODé¡µé¢" onclick="openModPage('${mod.mod_url}')">
                            MOD ID: ${mod.mod_id}
                        </span>
                        <button class="single-download-btn" onclick="${mod.status === 'downloading' ? `cancelDownload(${mod.id})` : `downloadSingleMod(${mod.id})`}" 
                                title="${mod.status === 'completed' ? 'é‡æ–°ä¸‹è½½æ­¤MOD' : mod.status === 'downloading' ? 'å–æ¶ˆä¸‹è½½' : 'å•ç‹¬ä¸‹è½½æ­¤MOD'}" 
                                ${mod.status === 'downloading' ? '' : ''}>
                            <i class="fas fa-${mod.status === 'downloading' ? 'times' : 'download'}"></i>
                            ${mod.status === 'completed' ? 'é‡æ–°ä¸‹è½½' : mod.status === 'downloading' ? 'å–æ¶ˆä¸‹è½½' : 'ä¸‹è½½'}
                        </button>
                    </div>
                ` : ''}
                <div class="mod-details">
                    <div class="mod-name">${mod.name}</div>
                    <div class="mod-name-cn">${mod.mod_size}</div>
                </div>
                ${mod.error ? `<div class="mod-error">${mod.error}</div>` : ''}
            </div>
            <div class="download-status">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${mod.progress}%"></div>
                </div>
                <div class="status-info">
                    <span class="progress-text">${mod.progress}%</span>
                    ${mod.speed ? `<span class="speed-text">${mod.speed}</span>` : ''}
                </div>
                <div class="status-icons">
                    <i class="fas fa-${getStatusIcon(mod.status)} status-icon ${mod.status}" 
                       ${mod.error ? `title="${mod.error}"` : ''}></i>
                    ${mod.status === 'completed' ? `
                        <i class="fas fa-folder-open open-folder-icon" 
                           data-filename="${mod.name}"
                           title="æ‰“å¼€æ–‡ä»¶æ‰€åœ¨ä½ç½®"></i>
                    ` : ''}
                </div>
            </div>
        `;
        container.appendChild(modElement);
    });
    
    updateSelectedCount();
}

// æ·»åŠ å–æ¶ˆä¸‹è½½çš„å‡½æ•°
function cancelDownload(modId) {
    fetch('/api/cancel-download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mod_id: modId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°modçŠ¶æ€
            const mod = modsList.find(m => m.id === modId);
            if (mod) {
                mod.status = 'cancelled';
                mod.error = 'ä¸‹è½½å·²å–æ¶ˆ';
                renderModsList();
            }
            NotificationManager.info('å·²å–æ¶ˆä¸‹è½½');
        } else {
            NotificationManager.error('å–æ¶ˆä¸‹è½½å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        console.error('å–æ¶ˆä¸‹è½½å¤±è´¥:', error);
        NotificationManager.error('å–æ¶ˆä¸‹è½½å¤±è´¥');
    });
}

// è·å–çŠ¶æ€å›¾æ ‡
function getStatusIcon(status) {
    switch (status) {
        case 'pending': return 'clock';
        case 'downloading': return 'spinner';
        case 'completed': return 'check-circle';
        case 'error': return 'exclamation-circle';
        default: return 'clock';
    }
}

// åˆ‡æ¢MODé€‰ä¸­çŠ¶æ€
function toggleMod(id) {
    const mod = modsList.find(m => m.id === id);
    if (mod) {
        mod.selected = !mod.selected;
        updateSelectedCount();
    }
}

// åˆ‡æ¢å…¨é€‰çŠ¶æ€
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllMods');
    const isSelected = selectAllCheckbox.checked;
    
    modsList.forEach(mod => {
        mod.selected = isSelected;
    });
    
    renderModsList();
}

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
    const selectedCount = modsList.filter(mod => mod.selected).length;
    document.getElementById('selectedModCount').textContent = selectedCount;
}

// è¿‡æ»¤MODåˆ—è¡¨
function filterMods() {
    const searchInput = document.getElementById('modSearchInput');
    const searchText = searchInput.value.toLowerCase();
    
    modsList.forEach(mod => {
        const modElement = document.querySelector(`[data-mod-id="${mod.id}"]`);
        if (modElement) {
            const isVisible = mod.name.toLowerCase().includes(searchText);
            modElement.style.display = isVisible ? 'flex' : 'none';
        }
    });
}

// å¼€å§‹æ‰¹é‡ä¸‹è½½
async function startBatchDownload() {
    const selectedMods = modsList.filter(mod => mod.selected);
    if (selectedMods.length === 0) {
        NotificationManager.error('è¯·é€‰æ‹©è¦ä¸‹è½½çš„MOD');
        return;
    }
    
    // æ·»åŠ ä¸€ä¸ªæ ‡å¿—ä½ï¼Œç”¨äºè·Ÿè¸ªæ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡ä¸‹è½½å®Œæˆé€šçŸ¥
    let hasShownCompletionNotification = false;
    
    try {
        // å‘é€ä¸‹è½½è¯·æ±‚
        const response = await fetch('/api/start-batch-download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mods: selectedMods.map(mod => ({
                    id: mod.id,
                    url: mod.url
                }))
            })
        });
        
        if (!response.ok) {
            throw new Error('å¯åŠ¨ä¸‹è½½å¤±è´¥');
        }
        
        // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
        socket.off('download_progress');
        
        // ç›‘å¬ä¸‹è½½è¿›åº¦
        socket.on('download_progress', (data) => {
            const mod = modsList.find(m => m.id === data.id);
            if (mod) {
                mod.progress = data.progress;
                mod.status = data.status;
                mod.speed = data.speed;
                mod.error = data.error;
                renderModsList();

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é€‰ä¸­çš„MODéƒ½ä¸‹è½½å®Œæˆï¼Œä¸”å°šæœªæ˜¾ç¤ºå®Œæˆé€šçŸ¥
                const allCompleted = selectedMods.every(m => m.status === 'completed');
                if (allCompleted && !hasShownCompletionNotification) {
                    // æ ‡è®°å·²æ˜¾ç¤ºé€šçŸ¥ï¼Œé˜²æ­¢é‡å¤
                    hasShownCompletionNotification = true;
                    
                    // æ˜¾ç¤ºä¸‹è½½å®Œæˆé€šçŸ¥
                    NotificationManager.success(`æ‰€æœ‰é€‰ä¸­çš„${selectedMods.length}ä¸ªMODå·²ä¸‹è½½å®Œæˆï¼`);
                }
            }
        });
        
        // æ›´æ–°çŠ¶æ€ä¸ºä¸‹è½½ä¸­
        selectedMods.forEach(mod => {
            mod.status = 'downloading';
            mod.progress = 0;
        });
        
        renderModsList();
        
    } catch (error) {
        console.error('æ‰¹é‡ä¸‹è½½å¤±è´¥:', error);
        NotificationManager.error('å¯åŠ¨ä¸‹è½½å¤±è´¥: ' + error.message);
    }
}

// æ·»åŠ å•ä¸ªMODä¸‹è½½åŠŸèƒ½
async function downloadSingleMod(id) {
    const mod = modsList.find(m => m.id === id);
    if (!mod) return;
    
    // è®¾ç½®é€‰ä¸­çŠ¶æ€
    modsList.forEach(m => m.selected = m.id === id);
    updateSelectedCount();
    
    // ç›´æ¥è°ƒç”¨æ‰¹é‡ä¸‹è½½å‡½æ•°
    await startBatchDownload();
}

// æ·»åŠ æ‰“å¼€æ–‡ä»¶ä½ç½®çš„å‡½æ•°
async function openFileLocation(filename) {

    console.log(123,"æ‰§è¡Œä½ç½®æ‰“å¼€");
    try {
        // å¯¹æ–‡ä»¶åè¿›è¡Œç¼–ç å¤„ç†
        const encodedFilename = encodeURIComponent(filename);
        
        const response = await fetch('/api/open-file-location', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filename: encodedFilename
            })
        });
        
        if (!response.ok) {
            throw new Error('æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥');
        }
        
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥');
        }
    } catch (error) {
        console.error('æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥:', error);
        NotificationManager.error('æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥: ' + error.message);
    }
}

// äº‹ä»¶å§”æ‰˜å¤„ç†æ‰“å¼€æ–‡ä»¶ä½ç½®
document.addEventListener('DOMContentLoaded', function() {
    document.body.addEventListener('click', function(e) {
        const target = e.target;
        if (target.classList.contains('open-folder-icon')) {
            const filename = target.dataset.filename;
            if (filename) {
                openFileLocation(filename);
            }
        }
    });
});

// æµ‹è¯•é€šçŸ¥çš„å‡½æ•°
function testNotifications() {
    // ä¾æ¬¡æ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„é€šçŸ¥
    setTimeout(() => {
        NotificationManager.success('è¿™æ˜¯ä¸€æ¡æˆåŠŸé€šçŸ¥');
    }, 0);
    
    setTimeout(() => {
        NotificationManager.info('è¿™æ˜¯ä¸€æ¡ä¿¡æ¯é€šçŸ¥');
    }, 1000);
    
    setTimeout(() => {
        NotificationManager.warning('è¿™æ˜¯ä¸€æ¡è­¦å‘Šé€šçŸ¥');
    }, 2000);
    
    setTimeout(() => {
        NotificationManager.error('è¿™æ˜¯ä¸€æ¡é”™è¯¯é€šçŸ¥');
    }, 3000);
}

// åœ¨å°çª—å£ä¸­æ‰“å¼€è¶…é“¾æ¥å†…å®¹
function openModPage(url) {
    const width = 800;
    const height = 600;
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    
    window.open(
        url, 
        'mod_page_window', 
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
    );
}

// æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©æ¸¸æˆ
function checkGameSelected() {
    return new Promise((resolve) => {
        fetch('/api/check-game-config')
            .then(response => response.json())
            .then(data => {
                if (!data.success || !data.hasGame) {
                    showGameSelectModal();
                    hideGameInfoBar();
                    resolve(false);
                } else {
                    selectedGame = data.game;
                    // è·å–å®Œæ•´çš„æ¸¸æˆä¿¡æ¯
                    fetchGameDetails(data.game.GAME_ID).then(() => {
                        resolve(true);
                    });
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥æ¸¸æˆé…ç½®å¤±è´¥:', error);
                showGameSelectModal();
                hideGameInfoBar();
                resolve(false);
            });
    });
}

// è·å–æ¸¸æˆè¯¦ç»†ä¿¡æ¯
async function fetchGameDetails(gameId) {
    try {
        const response = await fetch(`/api/get-game-details?game_id=${gameId}`);
        const data = await response.json();
        if (data.success) {
            updateGameInfoBar(data.game);
        } else {
            hideGameInfoBar();
        }
    } catch (error) {
        console.error('è·å–æ¸¸æˆè¯¦æƒ…å¤±è´¥:', error);
        hideGameInfoBar();
    }
}

// æ›´æ–°æ¸¸æˆä¿¡æ¯æ 
function updateGameInfoBar(game) {
    const gameInfoBar = document.getElementById('gameInfoBar');
    const currentGameImage = document.getElementById('currentGameImage');
    const currentGameName = document.getElementById('currentGameName');
    const currentGameMods = document.getElementById('currentGameMods').querySelector('span');
    const currentGameDownloads = document.getElementById('currentGameDownloads').querySelector('span');

    if (game) {
        currentGameImage.src = game.tileImageUrl;
        currentGameImage.alt = game.name;
        currentGameName.textContent = game.name;
        currentGameMods.textContent = formatNumber(game.modCount);
        currentGameDownloads.textContent = formatNumber(game.downloadCount);
        gameInfoBar.style.display = 'flex';
    } else {
        hideGameInfoBar();
    }
}

// éšè—æ¸¸æˆä¿¡æ¯æ 
function hideGameInfoBar() {
    const gameInfoBar = document.getElementById('gameInfoBar');
    // gameInfoBar.style.display = 'none';
}

// æ˜¾ç¤ºæ¸¸æˆé€‰æ‹©æ¨¡æ€çª—å£
async function showGameSelectModal() {
    const modal = document.getElementById('gameSelectModal');
    const closeBtn = document.getElementById('closeGameSelectBtn');
    
    try {
        // æ£€æŸ¥æ˜¯å¦å·²é…ç½®æ¸¸æˆ
        const response = await fetch('/api/check-game-config');
        const data = await response.json();
        
        // åªæœ‰åœ¨å·²ç»é…ç½®è¿‡æ¸¸æˆçš„æƒ…å†µä¸‹æ‰æ˜¾ç¤ºå…³é—­æŒ‰é’®
        if (data.success && data.hasGame) {
            closeBtn.style.display = 'block';
        } else {
            closeBtn.style.display = 'none';
        }
        
        // æ›´æ–°å†å²æ¸¸æˆè®°å½•
        updateHistoryGames();
        
        // åˆå§‹åŒ–æ ‡ç­¾é¡µ
        initTabs();
        
        // åŠ è½½æ”¶è—çš„æ¸¸æˆ
        loadFavoriteGames();

        // æ·»åŠ æ¸¸æˆæœç´¢äº‹ä»¶ç›‘å¬
        const gameSearchInput = document.getElementById('gameSearchInput');
        if (gameSearchInput) {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            gameSearchInput.removeEventListener('input', handleGameSearch);
            gameSearchInput.removeEventListener('keypress', handleSearchKeyPress);
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            gameSearchInput.addEventListener('input', handleGameSearch);
            gameSearchInput.addEventListener('keypress', handleSearchKeyPress);
        }
    } catch (error) {
        console.error('æ£€æŸ¥æ¸¸æˆé…ç½®å¤±è´¥:', error);
        closeBtn.style.display = 'none';
    }
    
    modal.classList.add('active');
    loadGames();
}

// å…³é—­æ¸¸æˆé€‰æ‹©æ¨¡æ€çª—å£
function closeGameSelectModal() {
    const modal = document.getElementById('gameSelectModal');
    modal.classList.remove('active');
}

// é€‰æ‹©æ¸¸æˆ
async function selectGame(game) {
    try {
        const response = await fetch('/api/save-game-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                game_id: game.id,
                domain_name: game.domainName
            })
        });

        const data = await response.json();
        if (data.success) {
            selectedGame = game;
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory(game);
            document.getElementById('gameSelectModal').classList.remove('active');
            updateGameInfoBar(game);
            NotificationManager.success(`å·²é€‰æ‹©æ¸¸æˆ: ${game.name}`);
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            document.getElementById('messageArea').innerHTML = '';
            // æ˜¾ç¤ºå…³é—­æŒ‰é’®
            document.getElementById('closeGameSelectBtn').style.display = 'block';
            
            // é‡æ–°è·å–èŠå¤©å†å²å’Œæ›´æ–°èŠå¤©ä¼šè¯åˆ—è¡¨
            await fetchChatHistory();
            await loadChatHistoryList();
            // æ›´æ–°ç©ºçŠ¶æ€æ˜¾ç¤º
            handleEmptyState();
        } else {
            NotificationManager.error('ä¿å­˜æ¸¸æˆé…ç½®å¤±è´¥');
        }
    } catch (error) {
        console.error('ä¿å­˜æ¸¸æˆé…ç½®å¤±è´¥:', error);
        NotificationManager.error('ä¿å­˜æ¸¸æˆé…ç½®å¤±è´¥');
    }
}



// åˆ›å»ºæ¸¸æˆå¡ç‰‡
async function createGameCard(game) {
    const card = document.createElement('div');
    card.className = 'game-card';
    
    // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å·²æ”¶è—
    const isFavorited = await isGameFavorited(game.id);
    
    card.innerHTML = `
        <button class="favorite-button ${isFavorited ? 'active' : ''}" title="${isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æ¸¸æˆ'}">
            <i class="fas ${isFavorited ? 'fa-heart' : 'fa-heart'}"></i>
        </button>
        <img src="${game.tileImageUrl}" alt="${game.name}" class="game-image">
        <div class="game-info">
            <div class="game-name">${game.name}</div>
            <div class="game-stats">
                <div class="game-stat">
                    <i class="fas fa-download"></i>
                    <span>${formatNumber(game.downloadCount)}</span>
                </div>
                <div class="game-stat">
                    <i class="fas fa-cube"></i>
                    <span>${formatNumber(game.modCount)}</span>
                </div>
            </div>
        </div>
    `;

    // æ·»åŠ æ”¶è—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const favoriteButton = card.querySelector('.favorite-button');
    favoriteButton.addEventListener('click', (e) => toggleFavorite(e, game));

    // æ·»åŠ å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆé€‰æ‹©æ¸¸æˆï¼‰
    card.addEventListener('click', () => selectGame(game));
    
    return card;
}

// æ ¼å¼åŒ–æ•°å­—
function formatNumber(num) {
    if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
    if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
    if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
    return num.toString();
}

// æ·»åŠ æ¸¸æˆæœç´¢é˜²æŠ–
let searchTimeout;
function handleGameSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        loadGames(true);
    }, 300);
}

// æ›´æ–°åˆ†é¡µç»„ä»¶
function updatePagination(currentPage, totalPages, totalCount) {
    const paginationContainer = document.getElementById('gamesPagination');
    const maxVisiblePages = 5; // æœ€å¤šæ˜¾ç¤ºçš„é¡µç æ•°
    
    let paginationHTML = '';
    
    // æ·»åŠ ä¸Šä¸€é¡µæŒ‰é’®
    paginationHTML += `
        <button class="pagination-button" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
    `;

    // è®¡ç®—æ˜¾ç¤ºçš„é¡µç èŒƒå›´
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // è°ƒæ•´startPageç¡®ä¿æ˜¾ç¤ºè¶³å¤Ÿçš„é¡µç 
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // æ·»åŠ ç¬¬ä¸€é¡µ
    if (startPage > 1) {
        paginationHTML += `
            <button class="pagination-button" onclick="changePage(1)">1</button>
        `;
        if (startPage > 2) {
            paginationHTML += '<span class="pagination-ellipsis">...</span>';
        }
    }

    // æ·»åŠ é¡µç æŒ‰é’®
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-button ${i === currentPage ? 'active' : ''}" 
                    onclick="changePage(${i})">${i}</button>
        `;
    }

    // æ·»åŠ æœ€åä¸€é¡µ
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += '<span class="pagination-ellipsis">...</span>';
        }
        paginationHTML += `
            <button class="pagination-button" onclick="changePage(${totalPages})">${totalPages}</button>
        `;
    }

    // æ·»åŠ ä¸‹ä¸€é¡µæŒ‰é’®
    paginationHTML += `
        <button class="pagination-button" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;

    // æ·»åŠ æ€»æ•°ä¿¡æ¯
    paginationHTML += `
        <span class="pagination-info">å…± ${totalCount} ä¸ªæ¸¸æˆ</span>
    `;

    paginationContainer.innerHTML = paginationHTML;
}

// åˆ‡æ¢é¡µç 
async function changePage(page) {
    if (page < 1 || page > totalPages || isLoading) return;
    currentPage = page;
    await loadGames();
}

// åˆå§‹åŒ–æ¸¸æˆé€‰æ‹©ç›¸å…³äº‹ä»¶
document.addEventListener('DOMContentLoaded', async function() {
    // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©æ¸¸æˆ
    const hasGame = await checkGameSelected();
    if (!hasGame) {
        // æ·»åŠ æ¸¸æˆæœç´¢äº‹ä»¶ç›‘å¬
        document.getElementById('gameSearchInput').addEventListener('input', handleGameSearch);
        
        // æ·»åŠ åŠ è½½æ›´å¤šäº‹ä»¶ç›‘å¬
        document.getElementById('loadMoreGames').addEventListener('click', () => {
            currentPage++;
            loadGames();
        });
    }
    
});


// è·å–å†å²æ¸¸æˆè®°å½•
function getHistoryGames() {
    try {
        const history = localStorage.getItem(HISTORY_GAMES_KEY);
        return history ? JSON.parse(history) : [];
    } catch (error) {
        console.error('è·å–å†å²æ¸¸æˆè®°å½•å¤±è´¥:', error);
        return [];
    }
}

// æ·»åŠ æ¸¸æˆåˆ°å†å²è®°å½•
function addToHistory(game) {
    try {
        let history = getHistoryGames();
        // ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒæ¸¸æˆ
        history = history.filter(g => Number(g.id) !== Number(game.id));
        // æ·»åŠ åˆ°å¼€å¤´
        history.unshift({
            id: game.id,
            name: game.name,
            tileImageUrl: game.tileImageUrl
        });
        // é™åˆ¶æ•°é‡
        if (history.length > MAX_HISTORY_GAMES) {
            history = history.slice(0, MAX_HISTORY_GAMES);
        }
        localStorage.setItem(HISTORY_GAMES_KEY, JSON.stringify(history));
        updateHistoryGames();
    } catch (error) {
        console.error('æ·»åŠ å†å²æ¸¸æˆè®°å½•å¤±è´¥:', error);
        NotificationManager.error('æ·»åŠ å†å²è®°å½•å¤±è´¥');
    }
}

// ä»å†å²è®°å½•ä¸­ç§»é™¤æ¸¸æˆ
function removeFromHistory(gameId) {
    try {
        let history = getHistoryGames();
        // ä½¿ç”¨æ•°å­—ç±»å‹è¿›è¡Œæ¯”è¾ƒ
        history = history.filter(g => Number(g.id) !== Number(gameId));
        localStorage.setItem(HISTORY_GAMES_KEY, JSON.stringify(history));
        updateHistoryGames();
        
        // æ·»åŠ åˆ é™¤æˆåŠŸçš„é€šçŸ¥
        NotificationManager.success('å·²ä»å†å²è®°å½•ä¸­ç§»é™¤è¯¥æ¸¸æˆ');
    } catch (error) {
        console.error('ç§»é™¤å†å²æ¸¸æˆè®°å½•å¤±è´¥:', error);
        NotificationManager.error('ç§»é™¤å†å²è®°å½•å¤±è´¥');
    }
}

// æ›´æ–°å†å²æ¸¸æˆè®°å½•æ˜¾ç¤º
async function updateHistoryGames() {
    const historyContainer = document.getElementById('historyGames');
    const history = getHistoryGames();
    
    if (history.length === 0) {
        historyContainer.style.display = 'none';
        return;
    }
    
    historyContainer.style.display = 'flex';
    
    // ä½¿ç”¨Promise.allç­‰å¾…æ‰€æœ‰æ¸¸æˆçš„æ”¶è—çŠ¶æ€æ£€æŸ¥å®Œæˆ
    const historyItems = await Promise.all(history.map(async game => {
        const isFavorited = await isGameFavorited(game.id);
        return `
            <div class="history-game-tag" onclick="searchHistoryGame('${game.name}')">
                <img src="${game.tileImageUrl}" alt="${game.name}">
                <span>${game.name}</span>
                <i class="fas ${isFavorited ? 'fa-heart' : 'fa-heart-o'}" 
                   style="color: ${isFavorited ? '#ff4757' : 'inherit'}; margin-left: 4px;"></i>
                <i class="fas fa-times remove-icon" onclick="event.stopPropagation(); removeFromHistory(${game.id})"></i>
            </div>
        `;
    }));
    
    historyContainer.innerHTML = historyItems.join('');
}

// æœç´¢å†å²æ¸¸æˆ
function searchHistoryGame(gameName) {
    const searchInput = document.getElementById('gameSearchInput');
    searchInput.value = gameName;
    handleGameSearch();
}

// æ”¶è—æ¸¸æˆåˆ—è¡¨ç¼“å­˜
let favoriteGamesCache = null;

// æ¸…é™¤æ”¶è—æ¸¸æˆç¼“å­˜
function clearFavoriteGamesCache() {
    favoriteGamesCache = null;
}

// è·å–æ”¶è—çš„æ¸¸æˆåˆ—è¡¨
async function getFavoriteGames() {
    try {
        // å¦‚æœæœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›ç¼“å­˜æ•°æ®
        if (favoriteGamesCache !== null) {
            return favoriteGamesCache;
        }

        const response = await fetch('/api/favorite-games-list');
        const data = await response.json();
        if (data.success) {
            // å¯¹æ¸¸æˆåˆ—è¡¨è¿›è¡Œå»é‡å¤„ç†
            const uniqueGames = data.games.filter((game, index, self) =>
                index === self.findIndex(g => Number(g.id) === Number(game.id))
            );
            // æ›´æ–°ç¼“å­˜
            favoriteGamesCache = uniqueGames;
            return uniqueGames;
        } else {
            console.error('è·å–æ”¶è—æ¸¸æˆå¤±è´¥:', data.error);
            return [];
        }
    } catch (error) {
        console.error('è·å–æ”¶è—æ¸¸æˆå¤±è´¥:', error);
        return [];
    }
}

// æ£€æŸ¥æ¸¸æˆæ˜¯å¦å·²æ”¶è—
async function isGameFavorited(gameId) {
    const favorites = await getFavoriteGames();
    return favorites.some(game => Number(game.id) === Number(gameId));
}

// åˆ‡æ¢æ¸¸æˆæ”¶è—çŠ¶æ€
async function toggleFavorite(event, game) {
    event.stopPropagation();

    try {
        // è·å–æ”¶è—æŒ‰é’®å…ƒç´ 
        const favoriteButton = event.currentTarget;
        if (!favoriteButton) {
            throw new Error('æ‰¾ä¸åˆ°æ”¶è—æŒ‰é’®å…ƒç´ ');
        }

        const gameId = Number(game.id);
        const isFavorited = await isGameFavorited(gameId);
        
        let response;
        if (isFavorited) {
            // å–æ¶ˆæ”¶è—
            response = await fetch(`/api/favorite-games/${gameId}`, {
                method: 'DELETE'
            });
        } else {
            // æ·»åŠ æ”¶è—
            response = await fetch('/api/favorite-games', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: game.id,
                    name: game.name,
                    tileImageUrl: game.tileImageUrl,
                    modCount: game.modCount,
                    downloadCount: game.downloadCount,
                    domainName: game.domainName
                })
            });
        }

        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'æ“ä½œå¤±è´¥');
        }

        // æ¸…é™¤æ”¶è—æ¸¸æˆç¼“å­˜
        clearFavoriteGamesCache();

        // æ›´æ–°UI
        favoriteButton.classList.toggle('active');
        favoriteButton.title = favoriteButton.classList.contains('active') ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æ¸¸æˆ';
        const icon = favoriteButton.querySelector('i');
        if (icon) {
            icon.className = `fas ${favoriteButton.classList.contains('active') ? 'fa-heart' : 'fa-heart'}`;
        }

        // æ˜¾ç¤ºæ“ä½œç»“æœé€šçŸ¥
        if (favoriteButton.classList.contains('active')) {
            NotificationManager.success(`å·²æ”¶è—: ${game.name}`);
        } else {
            NotificationManager.info(`å·²å–æ¶ˆæ”¶è—: ${game.name}`);
        }
        
        // å¦‚æœåœ¨å†å²è®°å½•ä¸­ï¼Œä¹Ÿæ›´æ–°å†å²è®°å½•çš„æ˜¾ç¤º
        await updateHistoryGames();
        
        // å¦‚æœå½“å‰åœ¨æ”¶è—æ ‡ç­¾é¡µï¼Œæ›´æ–°æ”¶è—åˆ—è¡¨
        const favoriteGamesTab = document.querySelector('.tab-button[data-tab="favoriteGames"]');
        if (favoriteGamesTab && favoriteGamesTab.classList.contains('active')) {
            await loadFavoriteGames();
        }

    } catch (error) {
        console.error('åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', error);
        NotificationManager.error(error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// åˆå§‹åŒ–æ ‡ç­¾é¡µ
function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„activeç±»
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            // æ·»åŠ å½“å‰æ ‡ç­¾é¡µçš„activeç±»
            button.classList.add('active');
            const tabId = button.dataset.tab;
            document.getElementById(tabId).classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°æ”¶è—æ ‡ç­¾é¡µï¼ŒåŠ è½½æ”¶è—çš„æ¸¸æˆ
            if (tabId === 'favoriteGames') {
                loadFavoriteGames();
            }
        });
    });
}

// åŠ è½½æ”¶è—çš„æ¸¸æˆ
async function loadFavoriteGames() {
    const favoriteGamesGrid = document.getElementById('favoriteGamesGrid');
    const favorites = await getFavoriteGames();
    
    if (favorites.length === 0) {
        favoriteGamesGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-heart"></i>
                <p>è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ¸¸æˆ</p>
            </div>
        `;
        return;
    }
    
    favoriteGamesGrid.innerHTML = '';
    try {
        // ä½¿ç”¨Promise.allç­‰å¾…æ‰€æœ‰æ¸¸æˆå¡ç‰‡åˆ›å»ºå®Œæˆ
        const gameCards = await Promise.all(favorites.map(game => createGameCard(game)));
        gameCards.forEach(card => favoriteGamesGrid.appendChild(card));
    } catch (error) {
        console.error('åŠ è½½æ”¶è—æ¸¸æˆå¤±è´¥:', error);
        NotificationManager.error('åŠ è½½æ”¶è—æ¸¸æˆå¤±è´¥');
    }
}

// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
function formatTime(timestamp) {
    const now = new Date();
    const date = new Date(timestamp);
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) {
        return `${days}å¤©å‰`;
    } else if (hours > 0) {
        return `${hours}å°æ—¶å‰`;
    } else if (minutes > 0) {
        return `${minutes}åˆ†é’Ÿå‰`;
    } else {
        return 'åˆšåˆš';
    }
}

// ç”Ÿæˆç©ºçŠ¶æ€HTMLçš„å‡½æ•°
function generateEmptyStateHTML() {
    return `
        <div class="empty-message-state" style="display: block;">
            <div class="empty-message-icon">
                <div class="avatar ai" title="ç‚¹å‡»æ›´æ¢å¤´åƒ"></div>
            </div>
            <h2 class="empty-message-title">æˆ‘æ˜¯ä½ çš„Nç½‘AIçŸ¥è¯†åº“v1.0.1</h2>
            <p class="empty-message-subtitle">ç”±DeepSeekå¤§æ¨¡å‹é©±åŠ¨ï¼Œæ”¯æŒä¸‰åƒå¤šæ¬¾æ¸¸æˆæ¨¡ç»„çš„ä¸‹è½½å’Œå®‰è£…æŒ‡å¯¼ï¼Œéšæ—¶å¾…å‘½ä¸ºæ‚¨æœåŠ¡ï¼ç‚¹å‡»æˆ‘å¯ä»¥è‡ªå®šä¹‰å¤´åƒè®¾ç½®</p>
            <div class="empty-message-features">
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="feature-title">æ¨¡ç»„ä¸‹è½½</div>
                    <div class="feature-desc">æ”¯æŒæ‰¹é‡ä¸‹è½½å’Œè‡ªåŠ¨æ›´æ–°</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="feature-title">å®‰è£…æŒ‡å¯¼</div>
                    <div class="feature-desc">è¯¦ç»†çš„å®‰è£…æ­¥éª¤è¯´æ˜</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-sync"></i>
                    </div>
                    <div class="feature-title">å®æ—¶æ›´æ–°</div>
                    <div class="feature-desc">åŠæ—¶è·å–æœ€æ–°æ¨¡ç»„ä¿¡æ¯</div>
                </div>
            </div>
        </div>
    `;
}

// æ·»åŠ é‡ç½®æ¶ˆæ¯åŒºåŸŸçš„å‡½æ•°
function resetMessageArea() {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = generateEmptyStateHTML();
    
    // åˆå§‹åŒ–ç©ºçŠ¶æ€AIå¤´åƒçš„ç‚¹å‡»äº‹ä»¶
    const emptyStateAvatar = messageArea.querySelector('.empty-message-icon .avatar.ai');
    if (emptyStateAvatar) {
        initAvatarUpload(emptyStateAvatar);
        
        // åº”ç”¨å½“å‰çš„å¤´åƒè®¾ç½®
        const cachedAiAvatar = localStorage.getItem('aiAvatar');
        if (cachedAiAvatar) {
            emptyStateAvatar.classList.add('custom-avatar');
            emptyStateAvatar.classList.remove('default-avatar');
        } else {
            emptyStateAvatar.classList.remove('custom-avatar');
            emptyStateAvatar.classList.add('default-avatar');
        }
    }
    
    return messageArea;
}

// åŠ è½½èŠå¤©ä¼šè¯å†å²åˆ—è¡¨
async function loadChatHistoryList() {
    try {
        const response = await fetch('/api/chat-history');
        const data = await response.json();
        
        if (data.success && data.sessions) {
            const historyList = document.getElementById('chatHistoryList');
            historyList.innerHTML = '';
            
            // æ¸²æŸ“èŠå¤©ä¼šè¯åˆ—è¡¨
            data.sessions.forEach(session => {
                const chatItem = createChatHistoryItem(session);
                historyList.appendChild(chatItem);
            });

            // æ·»åŠ é€šçŸ¥æŒ‰é’®åˆ°å†å²åˆ—è¡¨åº•éƒ¨
            addHistoryNotificationButton(historyList);

            // å¦‚æœæœ‰ä¼šè¯è®°å½•ï¼Œä¸”å½“å‰æ¶ˆæ¯åŒºåŸŸä¸ºç©ºï¼Œè‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªä¼šè¯
            if (data.sessions.length > 0) {
                const messageArea = document.getElementById('messageArea');
                if (!messageArea.children.length) {
                    await loadChatSession(data.sessions[0].filename);
                }
            }

        } else {
            console.error('è·å–èŠå¤©å†å²å¤±è´¥:', data.error);
        }
    } catch (error) {
        console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
    }
}

// æ·»åŠ å†å²åˆ—è¡¨åº•éƒ¨é€šçŸ¥åŠŸèƒ½
function addHistoryNotificationButton(historyList) {
    // åˆ›å»ºé€šçŸ¥æŒ‰é’®
    const notificationBtn = document.createElement('button');
    notificationBtn.className = 'history-notification-btn';
    notificationBtn.innerHTML = '<i class="fas fa-bell"></i>å…¬å‘Šä¸èµåŠ©';
    historyList.appendChild(notificationBtn);

    // å¦‚æœå¼¹çª—å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
    const existingModal = document.querySelector('.history-notification-modal');
    if (existingModal) {
        existingModal.remove();
    }

    // åˆ›å»ºé€šçŸ¥å¼¹çª—
    const modalHtml = `
        <div class="history-notification-modal">
            <div class="history-notification-content">
                <div class="history-notification-header">
                    <h3><i class="fas fa-bell"></i>æ¬¢è¿ä½¿ç”¨ã€æ”¹æ´º_å¼€å‘çš„Nç½‘AIåŠ©æ‰‹v1.0.1ç‰ˆæœ¬ã€‘</h3>
                    <button class="history-notification-close">&times;</button>
                </div>
                <div class="history-notification-body">
                    <div class="history-notification-text">
                        <p>1ã€è¿™ä¸ªé¡¹ç›®èƒ½åšåˆ°ä»€ä¹ˆç¨‹åº¦å®Œå…¨çœ‹å„ä½çš„æ”¯æŒäº†ï¼ï¼ï¼</p>
                        <p>2ã€ä¹‹åçš„è®¡åˆ’æ˜¯ å®Œæˆé…å¥—çš„ç®¡ç†å™¨ã€è‡ªåŠ¨æ›´æ–°modã€ä¸€é”®è‡ªåŠ¨å®‰è£…modã€è‡ªåŠ¨æ£€æµ‹å†²çªã€æœç´¢ç›¸ä¼¼æ€§modã€æ¥å…¥æœç´¢å¼•æ“</p>
                        <p>3ã€è®¿é—®æˆ‘çš„bç«™ç©ºé—´äº†è§£æœ€æ–°ä¿¡æ¯ï¼š<a href="https://space.bilibili.com/18718286" target="_blank">ç‚¹å‡»è®¿é—®</a> ä½œè€…ï¼šbç«™upæ”¹æ´º_</p>
                        <p>4ã€ğŸŒŸã€æ›´æ–°ä¸å‘å¸ƒåœ°å€ï¼šã€‘<a href="https://kdocs.cn/l/ck4sKeHQ48Wm" target="_blank">ç‚¹å‡»è®¿é—®</a></p>
                        <p>5ã€æ„Ÿè°¢æ‰€æœ‰çš„MODåˆ¶ä½œä»¬ï¼Œæˆ‘ä»¬æ‰æœ‰å¦‚æ­¤ä¸°å¯Œå¤šå½©çš„MODç¤¾åŒºï¼</p>
                        <p>6ã€---------------å¦‚æœæ‚¨å–œæ¬¢æœŸå¾…(âœ§âˆ€âœ§)æ‚¨çš„ä¸€é”®ä¸‰è¿ï¼ï¼ï¼----------------</p>
                    </div>
                    <div class="sponsor-images">
                        <h3>
                            ä¸€é”®ä¸‰è¿
                            <button class="toggle-images" title="æ˜¾ç¤º/éšè—èµèµç ">
                                <span class="eye-icon">ğŸ‘ï¸</span>
                                <span class="closed-eye-icon" style="display: none;">ğŸ˜Œ</span>
                            </button>
                        </h3>
                        <div class="image-container">
                            <img src="/static/uploads/images/wx.png" alt="å¾®ä¿¡èµèµç ">
                            <img src="/static/uploads/images/zfb.jpg" alt="æ”¯ä»˜å®èµèµç ">
                            <img src="/static/uploads/images/gm.png" alt="æ”¹æ´º_">
                        </div>
                    </div>
                </div>
                <div class="history-notification-footer">
                    <button class="history-notification-btn-close">
                        <i class="fas fa-check"></i>
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            </div>
        </div>
    `;

    // æ·»åŠ å¼¹çª—åˆ°body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const modal = document.querySelector('.history-notification-modal');
    const closeBtn = modal.querySelector('.history-notification-close');
    const confirmBtn = modal.querySelector('.history-notification-btn-close');
    const toggleImagesBtn = modal.querySelector('.toggle-images');
    const imageContainer = modal.querySelector('.image-container');
    const eyeIcon = toggleImagesBtn.querySelector('.eye-icon');
    const closedEyeIcon = toggleImagesBtn.querySelector('.closed-eye-icon');

    // ä»æœ¬åœ°å­˜å‚¨è·å–å›¾ç‰‡æ˜¾ç¤ºçŠ¶æ€
    const imagesHidden = localStorage.getItem('sponsorImagesHidden') === 'true';

    // æ ¹æ®å­˜å‚¨çš„çŠ¶æ€è®¾ç½®åˆå§‹æ˜¾ç¤º
    if (!imagesHidden) {
        imageContainer.style.display = 'flex';
        eyeIcon.style.display = 'inline';
        closedEyeIcon.style.display = 'none';
    } else {
        imageContainer.style.display = 'none';
        eyeIcon.style.display = 'none';
        closedEyeIcon.style.display = 'inline';
    }

    // åˆ‡æ¢å›¾ç‰‡æ˜¾ç¤ºçŠ¶æ€
    toggleImagesBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const isVisible = imageContainer.style.display === 'flex';
        
        if (isVisible) {
            imageContainer.style.display = 'none';
            eyeIcon.style.display = 'none';
            closedEyeIcon.style.display = 'inline';
        } else {
            imageContainer.style.display = 'flex';
            eyeIcon.style.display = 'inline';
            closedEyeIcon.style.display = 'none';
        }
        
        localStorage.setItem('sponsorImagesHidden', isVisible);
    });

    // æ˜¾ç¤ºå¼¹çª—
    function showModal() {
        modal.classList.add('show');
    }

    // å…³é—­å¼¹çª—
    function closeModal() {
        modal.classList.remove('show');
        // è®¾ç½®é€šçŸ¥å·²æ˜¾ç¤ºçš„æ ‡è®°
        localStorage.setItem('notificationShown', 'true');
    }

    // ç‚¹å‡»é€šçŸ¥æŒ‰é’®æ˜¾ç¤ºå¼¹çª—
    notificationBtn.addEventListener('click', showModal);

    // ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­å¼¹çª—
    closeBtn.addEventListener('click', closeModal);
    confirmBtn.addEventListener('click', closeModal);

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è®¿é—®
    const notificationShown = localStorage.getItem('notificationShown');
    
    // å¦‚æœæ˜¯é¦–æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºå¼¹çª—
    if (!notificationShown) {
        showModal();
    }

    // åˆ›å»ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
    const previewModalHtml = `
        <div class="image-preview-modal">
            <div class="image-preview-content">
                <button class="image-preview-close">&times;</button>
                <img src="" alt="">
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', previewModalHtml);

    const previewModal = document.querySelector('.image-preview-modal');
    const previewImage = previewModal.querySelector('img');
    const previewClose = previewModal.querySelector('.image-preview-close');

    // æ·»åŠ å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
    imageContainer.querySelectorAll('img').forEach(img => {
        img.addEventListener('click', function() {
            previewImage.src = this.src;
            previewImage.alt = this.alt;
            previewModal.classList.add('show');
        });
    });

    // å…³é—­é¢„è§ˆ
    function closePreview() {
        previewModal.classList.remove('show');
    }

    previewClose.addEventListener('click', closePreview);
    previewModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closePreview();
        }
    });

    // ESCé”®å…³é—­é¢„è§ˆ
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && previewModal.classList.contains('show')) {
            closePreview();
        }
    });
}

// åˆ›å»ºèŠå¤©å†å²é¡¹
function createChatHistoryItem(session) {
    const item = document.createElement('div');
    item.className = 'chat-history-item';
    if (session.is_current) {
        item.classList.add('active');
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
    const formattedDate = formatTime(session.modified_time * 1000);
    
    item.innerHTML = `
        <div class="chat-preview" data-filename="${session.filename}">${session.preview || 'æ–°èŠå¤©'}</div>
        <div class="chat-info">
            <span class="chat-date">${session.date}</span>
            <span class="chat-time">${formattedDate}</span>
        </div>
        <div class="chat-actions">
            <button class="delete-chat-btn" title="åˆ é™¤ä¼šè¯" onclick="event.stopPropagation(); deleteChatSession('${session.filename}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    item.addEventListener('click', () => loadChatSession(session.filename));
    
    return item;
}

// åŠ è½½ç‰¹å®šèŠå¤©ä¼šè¯
async function loadChatSession(filename) {
    try {
        // å…ˆåˆ‡æ¢ä¼šè¯
        const switchResponse = await fetch('/api/switch-chat-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename })
        });
        
        if (!switchResponse.ok) {
            throw new Error('åˆ‡æ¢ä¼šè¯å¤±è´¥');
        }

        // ç„¶ååŠ è½½ä¼šè¯å†…å®¹
        const response = await fetch(`/api/load-chat?filename=${filename}`);
        const data = await response.json();
        
        if (data.success) {
            // é‡ç½®æ¶ˆæ¯åŒºåŸŸ
            const messageArea = resetMessageArea();
            
            // æ¸²æŸ“æ¶ˆæ¯
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    if (message.role === 'user') {
                        renderUserMessage(message);
                    } else if (message.role === 'assistant') {
                        renderAIMessage(message);
                    }
                });
            }
            
            // æ›´æ–°æ´»åŠ¨çŠ¶æ€
            updateActiveHistoryItem(filename);
            
            // æ›´æ–°ç©ºçŠ¶æ€æ˜¾ç¤º
            handleEmptyState();
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    } catch (error) {
        console.error('åŠ è½½èŠå¤©ä¼šè¯å¤±è´¥:', error);
        NotificationManager.error('åŠ è½½èŠå¤©ä¼šè¯å¤±è´¥');
    }
}

// æ›´æ–°æ´»åŠ¨çš„å†å²è®°å½•é¡¹
function updateActiveHistoryItem(filename) {
    const items = document.querySelectorAll('.chat-history-item');
    items.forEach(item => {
        item.classList.remove('active');
        const preview = item.querySelector('.chat-preview');
        if (preview && preview.getAttribute('data-filename') === filename) {
            item.classList.add('active');
        }
    });
}

// åˆ é™¤èŠå¤©ä¼šè¯
async function deleteChatSession(filename) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠå¤©ä¼šè¯å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch('/api/delete-chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename })
        });

        const data = await response.json();
        if (data.success) {
            NotificationManager.success('èŠå¤©ä¼šè¯å·²åˆ é™¤');
            // é‡æ–°åŠ è½½èŠå¤©å†å²åˆ—è¡¨
            await loadChatHistoryList();
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼ŒåŠ è½½æ–°çš„å½“å‰ä¼šè¯
            if (data.current_file) {
                await loadChatSession(data.current_file);
            }
        } else {
            NotificationManager.error('åˆ é™¤èŠå¤©ä¼šè¯å¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ é™¤èŠå¤©ä¼šè¯å¤±è´¥:', error);
        NotificationManager.error('åˆ é™¤èŠå¤©ä¼šè¯å¤±è´¥');
    }
}

// æ–°å»ºèŠå¤©åŠŸèƒ½
async function newChat() {
    try {
        const response = await fetch('/api/clear-chat-history', {
            method: 'POST'
        });
        const data = await response.json();

        if (data.success) {
            // é‡ç½®æ¶ˆæ¯åŒºåŸŸ
            resetMessageArea();
            
            // é‡æ–°åŠ è½½èŠå¤©å†å²åˆ—è¡¨
            await loadChatHistoryList();
            
            // åŠ è½½æ–°åˆ›å»ºçš„ä¼šè¯
            if (data.filename) {
                await loadChatSession(data.filename);
            }
            
            // æ›´æ–°ç©ºçŠ¶æ€æ˜¾ç¤º
            handleEmptyState();
            
            NotificationManager.success('æ–°çš„èŠå¤©ä¼šè¯å·²åˆ›å»º');
        } else {
            NotificationManager.error('åˆ›å»ºæ–°èŠå¤©ä¼šè¯å¤±è´¥');
        }
    } catch (error) {
        console.error('æ–°å»ºèŠå¤©å¤±è´¥:', error);
        NotificationManager.error('åˆ›å»ºæ–°èŠå¤©ä¼šè¯å¤±è´¥');
    }
}

// æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
function renderUserMessage(message) {
    const userDiv = document.createElement('div');
    userDiv.className = 'message user-container';
    
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp(message.timestamp);
    userDiv.appendChild(timestamp);
    
    const userAvatar = document.createElement('div');
    userAvatar.className = 'avatar user';
    const cachedUserAvatar = localStorage.getItem('userAvatar');
    if (cachedUserAvatar) {
        userAvatar.classList.add('custom-avatar');
        userAvatar.classList.remove('default-avatar');
    } else {
        userAvatar.classList.remove('custom-avatar');
        userAvatar.classList.add('default-avatar');
        userAvatar.textContent = 'U';
    }
    
    // æ·»åŠ å¤´åƒç‚¹å‡»äº‹ä»¶
    initAvatarUpload(userAvatar);
    
    userDiv.appendChild(userAvatar);
    
    const userContent = document.createElement('div');
    userContent.className = 'user-message';
    userContent.textContent = message.content;
    userDiv.appendChild(userContent);
    
    document.getElementById('messageArea').appendChild(userDiv);
}

// æ¸²æŸ“AIæ¶ˆæ¯
function renderAIMessage(message) {
    const aiDiv = document.createElement('div');
    aiDiv.className = 'message';
    
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = formatTimestamp(message.timestamp);
    aiDiv.appendChild(timestamp);
    
    const aiAvatar = document.createElement('div');
    aiAvatar.className = 'avatar ai';
    const cachedAiAvatar = localStorage.getItem('aiAvatar');
    if (cachedAiAvatar) {
        aiAvatar.classList.add('custom-avatar');
        aiAvatar.classList.remove('default-avatar');
    } else {
        aiAvatar.classList.remove('custom-avatar');
        aiAvatar.classList.add('default-avatar');
    }
    
    // æ·»åŠ å¤´åƒç‚¹å‡»äº‹ä»¶
    initAvatarUpload(aiAvatar);
    
    aiDiv.appendChild(aiAvatar);
    
    const aiContent = document.createElement('div');
    aiContent.className = 'ai-message';
    renderMessageContent(message.content, aiContent);
    aiDiv.appendChild(aiContent);
    
    document.getElementById('messageArea').appendChild(aiDiv);
}

// åœ¨åˆå§‹åŒ–æ—¶åŠ è½½èŠå¤©å†å²
document.addEventListener('DOMContentLoaded', function() {
    // ... existing initialization code ...
    
    // åŠ è½½èŠå¤©å†å²åˆ—è¡¨
    loadChatHistoryList();
});


// èŠå¤©å†å²ä¾§è¾¹æ åˆ‡æ¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
    const historyToggle = document.getElementById('historyToggle');
    const historySidebar = document.querySelector('.chat-history-sidebar');

    if (historyToggle && historySidebar) {
        historyToggle.addEventListener('click', () => {
            historySidebar.classList.toggle('collapsed');
        });

        // åŒå‡»å†å²è®°å½•å¤´éƒ¨ä¹Ÿå¯ä»¥åˆ‡æ¢
        const historyHeader = document.querySelector('.chat-history-header');
        if (historyHeader) {
            historyHeader.addEventListener('dblclick', () => {
                historySidebar.classList.toggle('collapsed');
            });
        }
    }
});

// è·å–å¹¶æ›´æ–°åœ¨çº¿äººæ•°
function updateOnlineCount() {
    fetch('/get_ip_count')
        .then(response => response.json())
        .then(data => {
            const count = data.data || 0;
            document.getElementById('ai-online-count').innerHTML = `
                <i class="fas fa-users"></i>
                <span>${count} äººåœ¨çº¿</span>
            `;
        })
        .catch(error => {
            console.error('è·å–åœ¨çº¿äººæ•°å¤±è´¥:', error);
            document.getElementById('ai-online-count').innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>è·å–å¤±è´¥</span>
            `;
        });
}



// æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€çš„å‡½æ•°
function checkInitialization() {
    $.ajax({
        url: '/ist_init',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ sys_version: 'v1.0.1' }),

        success: function (response) {
            if (!response.success) {
                // å¤„ç†æ¶ˆæ¯ä¸­çš„URL
                const message = convertMessageToHtml(response.message);

                const modalHtml = `
                    <div id="init-error-modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
                        <div style="background: #0a2342; padding: 20px; border-radius: 5px; max-width: 80%; text-align: center; position: relative;">
                          
                            <h3 style="color: #3498db;">ç³»ç»Ÿæé†’</h3>
                            <p style="margin: 20px 0; color: #fff;">${message}</p>
                          
                        </div>
                    </div>
                `;

                $('#init-error-modal').remove();
                $('body').append(modalHtml);

                $('.close-modal-btn, .confirm-btn').on('click', function () {
                    $('#init-error-modal').remove();
                });
            }
        },
        error: function (error) {
            // å¤„ç†é”™è¯¯æ¶ˆæ¯ä¸­çš„URL
            const message = convertMessageToHtml(error.responseJSON?.message || error.message || 'æœªçŸ¥é”™è¯¯');

            const modalHtml = `
                <div id="init-error-modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
                    <div style="background: #0a2342; padding: 20px; border-radius: 5px; max-width: 80%; text-align: center; position: relative;">
                        <h3 style="color: #3498db;">ç³»ç»Ÿæé†’</h3>
                        <p style="margin: 20px 0; color: #fff;">${message}</p>
                     
                    </div>
                </div>
            `;

            $('#init-error-modal').remove();
            $('body').append(modalHtml);

            $('.close-modal-btn, .confirm-btn').on('click', function () {
                $('#init-error-modal').remove();
            });
        }
    });
}

// å°†æ¶ˆæ¯ä¸­çš„URLè½¬æ¢ä¸ºHTMLé“¾æ¥çš„å‡½æ•°
function convertMessageToHtml(message) {
    if (!message) return '';

    // URLåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼
    const urlRegex = /(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/g;

    // å°†URLè½¬æ¢ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
    return message.replace(urlRegex, function (url) {
        return `<a href="${url}" target="_blank" style="color: #3498db; text-decoration: underline; cursor: pointer;">${url}</a>`;
    });
}

// é¡µé¢åŠ è½½æ—¶è·å–åœ¨çº¿äººæ•°ï¼Œå¹¶æ¯30ç§’æ›´æ–°ä¸€æ¬¡
document.addEventListener('DOMContentLoaded', function() {
    // ... existing initialization code ...
    
    // åˆå§‹è·å–åœ¨çº¿äººæ•°
    updateOnlineCount();
    
    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡åœ¨çº¿äººæ•°
    setInterval(updateOnlineCount, 30000);
    // æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
    checkInitialization();
});

// æ·»åŠ æœç´¢æŒ‰é”®å¤„ç†å‡½æ•°
function handleSearchKeyPress(e) {
    console.log('æŒ‰é”®è¢«æŒ‰ä¸‹:', e.key);  // è°ƒè¯•æ—¥å¿—
    if (e.key === 'Enter') {
        console.log('å›è½¦é”®è¢«æŒ‰ä¸‹ï¼Œå¼€å§‹æœç´¢...');  // è°ƒè¯•æ—¥å¿—
        e.preventDefault();
        loadGames(true);
    }
}

// ç¦ç”¨èŠå¤©å†å²åˆ‡æ¢åŠŸèƒ½
function disableChatHistorySwitch() {
    const historyItems = document.querySelectorAll('.chat-history-item');
    historyItems.forEach(item => {
        item.style.pointerEvents = 'none';
        item.style.opacity = '0.5';
        item.style.cursor = 'not-allowed';
        
        // ç¦ç”¨åˆ é™¤æŒ‰é’®
        const deleteBtn = item.querySelector('.delete-chat-btn');
        if (deleteBtn) {
            deleteBtn.disabled = true;
            deleteBtn.style.pointerEvents = 'none';
            deleteBtn.style.opacity = '0.5';
        }
    });
    
    // ç¦ç”¨æ–°å»ºèŠå¤©æŒ‰é’®
    const newChatBtn = document.querySelector('.new-chat-button');
    if (newChatBtn) {
        newChatBtn.disabled = true;
        newChatBtn.style.pointerEvents = 'none';
        newChatBtn.style.opacity = '0.5';
    }
}

// æ¢å¤èŠå¤©å†å²åˆ‡æ¢åŠŸèƒ½
function enableChatHistorySwitch() {
    console.log('æ¢å¤èŠå¤©å†å²åˆ‡æ¢åŠŸèƒ½');
    const historyItems = document.querySelectorAll('.chat-history-item');
    historyItems.forEach(item => {
        item.style.pointerEvents = 'auto';
        item.style.opacity = '1';
        item.style.cursor = 'pointer';
        
        // æ¢å¤åˆ é™¤æŒ‰é’®
        const deleteBtn = item.querySelector('.delete-chat-btn');
        if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.style.pointerEvents = 'auto';
            deleteBtn.style.opacity = '1';
        }
    });
    
    // æ¢å¤æ–°å»ºèŠå¤©æŒ‰é’®
    const newChatBtn = document.querySelector('.new-chat-button');
    if (newChatBtn) {
        newChatBtn.disabled = false;
        newChatBtn.style.pointerEvents = 'auto';
        newChatBtn.style.opacity = '1';
    }
}

// æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    const messageArea = document.getElementById('messageArea');
    if (messageArea) {
        messageArea.addEventListener('wheel', function() {
            userHasScrolled = true;
            // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
            const isAtBottom = messageArea.scrollHeight - messageArea.scrollTop - messageArea.clientHeight < 10;
            if (isAtBottom) {
                userHasScrolled = false;
            }
        });
        
        // ç›‘å¬è§¦æ‘¸æ»šåŠ¨
        messageArea.addEventListener('touchmove', function() {
            userHasScrolled = true;
        });
        
        messageArea.addEventListener('touchend', function() {
            // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
            const isAtBottom = messageArea.scrollHeight - messageArea.scrollTop - messageArea.clientHeight < 10;
            if (isAtBottom) {
                userHasScrolled = false;
            }
        });
    }
});

// åŠ è½½æ¸¸æˆåˆ—è¡¨
async function loadGames(isSearch = false) {
    if (isLoading || (!hasMoreGames && !isSearch)) return;
    
    isLoading = true;
    const gamesGrid = document.getElementById('gamesGrid');
    
    if (isSearch) {
        currentPage = 1;
    }
    
    // åˆ›å»ºéª¨æ¶å±æ•ˆæœ
    gamesGrid.innerHTML = Array(5).fill(`
        <div class="game-card skeleton">
            <div class="skeleton-image"></div>
            <div class="skeleton-info">
                <div class="skeleton-name"></div>
                <div class="skeleton-stats">
                    <div class="skeleton-stat"></div>
                    <div class="skeleton-stat"></div>
                </div>
            </div>
        </div>
    `).join('');

    try {
        const searchQuery = document.getElementById('gameSearchInput').value;
        const response = await fetch(`/api/search-games?page=${currentPage}&game_name=${encodeURIComponent(searchQuery)}&page_size=${pageSize}`);
        const data = await response.json();

        gamesGrid.innerHTML = '';

        if (data.success) {
            const { games, pagination } = data.data;
            totalPages = pagination.total_pages;
            
            if (games.length === 0) {
                gamesGrid.innerHTML = '<div class="no-games-message">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ¸¸æˆ</div>';
            } else {
                // ä½¿ç”¨Promise.allç­‰å¾…æ‰€æœ‰æ¸¸æˆå¡ç‰‡åˆ›å»ºå®Œæˆ
                const gameCards = await Promise.all(games.map(game => createGameCard(game)));
                gameCards.forEach(card => gamesGrid.appendChild(card));
            }

            // æ›´æ–°åˆ†é¡µç»„ä»¶
            updatePagination(pagination.current_page, pagination.total_pages, pagination.total_count);
        } else {
            NotificationManager.error('åŠ è½½æ¸¸æˆåˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½æ¸¸æˆå¤±è´¥:', error);
        NotificationManager.error('åŠ è½½æ¸¸æˆåˆ—è¡¨å¤±è´¥');
    } finally {
        isLoading = false;
    }
}
// ç”¨äºåœ¨é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç©ºçŠ¶æ€
window.addEventListener('load', function() {
    setTimeout(() => {
        if (typeof handleEmptyState === 'function') {
            handleEmptyState();
        }
    }, 500);
});

